<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enquiries - BHRC Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../assets/css/common.css" rel="stylesheet">
    <link href="../assets/css/admin.css" rel="stylesheet">
    <style>
        .enquiry-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 4px solid #007bff;
        }
        .enquiry-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .enquiry-card.urgent {
            border-left-color: #dc3545;
        }
        .enquiry-card.high {
            border-left-color: #fd7e14;
        }
        .enquiry-card.medium {
            border-left-color: #ffc107;
        }
        .enquiry-card.low {
            border-left-color: #28a745;
        }
        .enquiry-card.resolved {
            border-left-color: #6c757d;
            opacity: 0.8;
        }
        .priority-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-new { background-color: #007bff; }
        .status-in-progress { background-color: #ffc107; }
        .status-resolved { background-color: #28a745; }
        .status-closed { background-color: #6c757d; }
        .enquiry-preview {
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        .response-timeline {
            max-height: 300px;
            overflow-y: auto;
        }
        .timeline-item {
            border-left: 2px solid #dee2e6;
            padding-left: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #007bff;
        }
        .timeline-item.response::before {
            background: #28a745;
        }
        .timeline-item.note::before {
            background: #ffc107;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        .quick-actions {
            position: sticky;
            top: 20px;
        }
        .enquiry-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .attachment-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-shield-alt"></i> BHRC Admin</h4>
        </div>
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="members.html" class="nav-link">
                <i class="fas fa-users"></i> Members
            </a>
            <a href="associates.html" class="nav-link">
                <i class="fas fa-handshake"></i> Associates
            </a>
            <a href="activities.html" class="nav-link">
                <i class="fas fa-calendar-alt"></i> Activities
            </a>
            <a href="events.html" class="nav-link">
                <i class="fas fa-calendar-check"></i> Events
            </a>
            <a href="enquires.html" class="nav-link active">
                <i class="fas fa-envelope"></i> Enquiries
            </a>
            <a href="complaints.html" class="nav-link">
                <i class="fas fa-exclamation-triangle"></i> Complaints
            </a>
            <a href="gallery.html" class="nav-link">
                <i class="fas fa-images"></i> Gallery
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="main-header">
            <div class="header-left">
                <button class="btn btn-link sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Enquiries</h1>
            </div>
            <div class="header-right">
                <button class="btn btn-success me-2" onclick="bulkMarkResolved()">
                    <i class="fas fa-check"></i> Mark Resolved
                </button>
                <button class="btn btn-outline-primary me-2" onclick="exportEnquiries()">
                    <i class="fas fa-download"></i> Export
                </button>
                <div class="dropdown">
                    <button class="btn btn-link dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle"></i> Admin
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-user"></i> Profile</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-cog"></i> Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                    </ul>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="content-wrapper">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">New</h6>
                                    <h3 id="newEnquiriesCount">0</h3>
                                </div>
                                <i class="fas fa-envelope fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">In Progress</h6>
                                    <h3 id="inProgressCount">0</h3>
                                </div>
                                <i class="fas fa-clock fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Resolved</h6>
                                    <h3 id="resolvedCount">0</h3>
                                </div>
                                <i class="fas fa-check-circle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Avg Response Time</h6>
                                    <h3 id="avgResponseTime">0h</h3>
                                </div>
                                <i class="fas fa-stopwatch fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search enquiries...">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="new">New</option>
                                <option value="in-progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="priorityFilter">
                                <option value="">All Priority</option>
                                <option value="urgent">Urgent</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="categoryFilter">
                                <option value="">All Categories</option>
                                <option value="general">General</option>
                                <option value="legal-aid">Legal Aid</option>
                                <option value="membership">Membership</option>
                                <option value="complaint">Complaint</option>
                                <option value="support">Support</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="dateFilter">
                                <option value="">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                                <label class="form-check-label" for="selectAll">All</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enquiries List -->
            <div class="row">
                <div class="col-md-8">
                    <div id="enquiriesContainer">
                        <!-- Enquiries will be loaded here -->
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Enquiries pagination" class="mt-4">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination will be generated here -->
                        </ul>
                    </nav>
                </div>

                <div class="col-md-4">
                    <div class="quick-actions">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-bolt"></i> Quick Actions</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="showBulkResponseModal()">
                                        <i class="fas fa-reply-all"></i> Bulk Response
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="bulkMarkResolved()">
                                        <i class="fas fa-check"></i> Mark as Resolved
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="bulkAssignPriority()">
                                        <i class="fas fa-flag"></i> Assign Priority
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="bulkCategorize()">
                                        <i class="fas fa-tags"></i> Categorize
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="bulkArchive()">
                                        <i class="fas fa-archive"></i> Archive
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-chart-pie"></i> Category Distribution</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="categoryChart" height="200"></canvas>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-clock"></i> Response Time Stats</h6>
                            </div>
                            <div class="card-body">
                                <div class="stats-card p-3 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Avg Response</span>
                                        <strong id="avgResponseDetail">2.5h</strong>
                                    </div>
                                </div>
                                <div class="stats-card p-3 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Fastest Response</span>
                                        <strong id="fastestResponse">15m</strong>
                                    </div>
                                </div>
                                <div class="stats-card p-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Pending > 24h</span>
                                        <strong id="overdue">3</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enquiry Details Modal -->
    <div class="modal fade" id="enquiryDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="enquiryDetailsTitle">Enquiry Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="enquiryDetailsContent">
                        <!-- Enquiry details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" id="markInProgressBtn" onclick="updateEnquiryStatus('in-progress')">
                        <i class="fas fa-clock"></i> Mark In Progress
                    </button>
                    <button type="button" class="btn btn-success" id="markResolvedBtn" onclick="updateEnquiryStatus('resolved')">
                        <i class="fas fa-check"></i> Mark Resolved
                    </button>
                    <button type="button" class="btn btn-primary" onclick="showResponseModal()">
                        <i class="fas fa-reply"></i> Respond
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Response Modal -->
    <div class="modal fade" id="responseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Response</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="responseForm">
                        <div class="mb-3">
                            <label class="form-label">Response Type</label>
                            <select class="form-select" id="responseType">
                                <option value="email">Email Response</option>
                                <option value="phone">Phone Call</option>
                                <option value="meeting">Schedule Meeting</option>
                                <option value="internal">Internal Note</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subject</label>
                            <input type="text" class="form-control" id="responseSubject" placeholder="Response subject">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Message *</label>
                            <textarea class="form-control" id="responseMessage" rows="6" required placeholder="Type your response here..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Priority</label>
                            <select class="form-select" id="responsePriority">
                                <option value="normal">Normal</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Attachments</label>
                            <input type="file" class="form-control" id="responseAttachments" multiple>
                            <div class="form-text">You can attach multiple files</div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="markAsResolved">
                                <label class="form-check-label" for="markAsResolved">
                                    Mark enquiry as resolved after sending response
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" onclick="saveDraft()">
                        <i class="fas fa-save"></i> Save Draft
                    </button>
                    <button type="button" class="btn btn-primary" onclick="sendResponse()">
                        <i class="fas fa-paper-plane"></i> Send Response
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div class="modal fade" id="bulkActionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkActionTitle">Bulk Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="bulkActionContent">
                        <!-- Bulk action content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmBulkAction">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        class EnquiriesManager {
            constructor() {
                this.enquiries = [];
                this.filteredEnquiries = [];
                this.selectedEnquiries = new Set();
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.currentEnquiryId = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadEnquiries();
                this.updateStats();
                this.renderCategoryChart();
            }

            setupEventListeners() {
                // Search and filters
                document.getElementById('searchInput').addEventListener('input', () => this.filterEnquiries());
                document.getElementById('statusFilter').addEventListener('change', () => this.filterEnquiries());
                document.getElementById('priorityFilter').addEventListener('change', () => this.filterEnquiries());
                document.getElementById('categoryFilter').addEventListener('change', () => this.filterEnquiries());
                document.getElementById('dateFilter').addEventListener('change', () => this.filterEnquiries());
                
                // Select all checkbox
                document.getElementById('selectAll').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.filteredEnquiries.forEach(enquiry => this.selectedEnquiries.add(enquiry.id));
                    } else {
                        this.selectedEnquiries.clear();
                    }
                    this.renderEnquiries();
                });
            }

            async loadEnquiries() {
                try {
                    // Simulate API call
                    const response = await fetch(window.BHRC_CONFIG ? window.BHRC_CONFIG.API.BASE_URL + ''.replace('/api', '') : 'https://bhrcdata.online/backend/api'.replace('/api', '')));
                    // For demo, use mock data
                    this.enquiries = this.getMockEnquiries();
                    this.filteredEnquiries = [...this.enquiries];
                    this.renderEnquiries();
                    this.updateStats();
                } catch (error) {
                    console.error('Error loading enquiries:', error);
                    // Use mock data for demo
                    this.enquiries = this.getMockEnquiries();
                    this.filteredEnquiries = [...this.enquiries];
                    this.renderEnquiries();
                    this.updateStats();
                }
            }

            getMockEnquiries() {
                return [
                    {
                        id: 1,
                        name: 'Rajesh Kumar',
                        email: 'rajesh.kumar@email.com',
                        phone: '+91 98765 43210',
                        subject: 'Legal Aid Request for Property Dispute',
                        message: 'I am facing a property dispute with my neighbor and need legal assistance. The issue has been ongoing for 6 months and I need urgent help.',
                        category: 'legal-aid',
                        priority: 'high',
                        status: 'new',
                        submittedAt: '2024-01-15T10:30:00Z',
                        lastUpdated: '2024-01-15T10:30:00Z',
                        assignedTo: null,
                        responses: [],
                        attachments: ['property_documents.pdf'],
                        source: 'website',
                        ipAddress: '192.168.1.100'
                    },
                    {
                        id: 2,
                        name: 'Priya Sharma',
                        email: 'priya.sharma@email.com',
                        phone: '+91 87654 32109',
                        subject: 'Membership Application Query',
                        message: 'I would like to know about the membership process and requirements. Can someone guide me through the application process?',
                        category: 'membership',
                        priority: 'medium',
                        status: 'in-progress',
                        submittedAt: '2024-01-14T14:20:00Z',
                        lastUpdated: '2024-01-15T09:15:00Z',
                        assignedTo: 'Admin User',
                        responses: [
                            {
                                id: 1,
                                type: 'email',
                                message: 'Thank you for your interest. I will send you the membership details shortly.',
                                sentAt: '2024-01-15T09:15:00Z',
                                sentBy: 'Admin User'
                            }
                        ],
                        attachments: [],
                        source: 'contact-form',
                        ipAddress: '192.168.1.101'
                    },
                    {
                        id: 3,
                        name: 'Amit Patel',
                        email: 'amit.patel@email.com',
                        phone: '+91 76543 21098',
                        subject: 'Complaint about Police Harassment',
                        message: 'I want to file a complaint about police harassment in my area. This is a serious matter and needs immediate attention.',
                        category: 'complaint',
                        priority: 'urgent',
                        status: 'new',
                        submittedAt: '2024-01-15T16:45:00Z',
                        lastUpdated: '2024-01-15T16:45:00Z',
                        assignedTo: null,
                        responses: [],
                        attachments: ['incident_photos.zip'],
                        source: 'phone',
                        ipAddress: null
                    },
                    {
                        id: 4,
                        name: 'Sunita Devi',
                        email: 'sunita.devi@email.com',
                        phone: '+91 65432 10987',
                        subject: 'General Information Request',
                        message: 'I need information about your organization and the services you provide. Please send me a brochure.',
                        category: 'general',
                        priority: 'low',
                        status: 'resolved',
                        submittedAt: '2024-01-12T11:00:00Z',
                        lastUpdated: '2024-01-13T15:30:00Z',
                        assignedTo: 'Admin User',
                        responses: [
                            {
                                id: 1,
                                type: 'email',
                                message: 'Thank you for your inquiry. Please find attached our organization brochure with detailed information.',
                                sentAt: '2024-01-13T15:30:00Z',
                                sentBy: 'Admin User'
                            }
                        ],
                        attachments: [],
                        source: 'website',
                        ipAddress: '192.168.1.102'
                    },
                    {
                        id: 5,
                        name: 'Vikram Singh',
                        email: 'vikram.singh@email.com',
                        phone: '+91 54321 09876',
                        subject: 'Technical Support Request',
                        message: 'I am having trouble accessing the member portal. Can you please help me reset my password?',
                        category: 'support',
                        priority: 'medium',
                        status: 'resolved',
                        submittedAt: '2024-01-13T09:30:00Z',
                        lastUpdated: '2024-01-13T10:45:00Z',
                        assignedTo: 'Tech Support',
                        responses: [
                            {
                                id: 1,
                                type: 'email',
                                message: 'I have reset your password. Please check your email for the new login credentials.',
                                sentAt: '2024-01-13T10:45:00Z',
                                sentBy: 'Tech Support'
                            }
                        ],
                        attachments: [],
                        source: 'email',
                        ipAddress: null
                    },
                    {
                        id: 6,
                        name: 'Meera Joshi',
                        email: 'meera.joshi@email.com',
                        phone: '+91 43210 98765',
                        subject: 'Workshop Registration Inquiry',
                        message: 'I would like to register for the upcoming human rights workshop. Please let me know the registration process and fees.',
                        category: 'general',
                        priority: 'medium',
                        status: 'in-progress',
                        submittedAt: '2024-01-14T13:15:00Z',
                        lastUpdated: '2024-01-15T08:20:00Z',
                        assignedTo: 'Events Team',
                        responses: [
                            {
                                id: 1,
                                type: 'phone',
                                message: 'Called the enquirer and provided workshop details. Waiting for confirmation.',
                                sentAt: '2024-01-15T08:20:00Z',
                                sentBy: 'Events Team'
                            }
                        ],
                        attachments: [],
                        source: 'website',
                        ipAddress: '192.168.1.103'
                    }
                ];
            }

            filterEnquiries() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const priorityFilter = document.getElementById('priorityFilter').value;
                const categoryFilter = document.getElementById('categoryFilter').value;
                const dateFilter = document.getElementById('dateFilter').value;

                this.filteredEnquiries = this.enquiries.filter(enquiry => {
                    const matchesSearch = enquiry.name.toLowerCase().includes(searchTerm) ||
                                        enquiry.email.toLowerCase().includes(searchTerm) ||
                                        enquiry.subject.toLowerCase().includes(searchTerm) ||
                                        enquiry.message.toLowerCase().includes(searchTerm);
                    const matchesStatus = !statusFilter || enquiry.status === statusFilter;
                    const matchesPriority = !priorityFilter || enquiry.priority === priorityFilter;
                    const matchesCategory = !categoryFilter || enquiry.category === categoryFilter;
                    
                    let matchesDate = true;
                    if (dateFilter) {
                        const enquiryDate = new Date(enquiry.submittedAt);
                        const now = new Date();
                        switch (dateFilter) {
                            case 'today':
                                matchesDate = enquiryDate.toDateString() === now.toDateString();
                                break;
                            case 'week':
                                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                                matchesDate = enquiryDate >= weekAgo;
                                break;
                            case 'month':
                                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                                matchesDate = enquiryDate >= monthAgo;
                                break;
                            case 'quarter':
                                const quarterAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                                matchesDate = enquiryDate >= quarterAgo;
                                break;
                        }
                    }

                    return matchesSearch && matchesStatus && matchesPriority && matchesCategory && matchesDate;
                });

                this.currentPage = 1;
                this.renderEnquiries();
            }

            renderEnquiries() {
                const container = document.getElementById('enquiriesContainer');
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const enquiriesToShow = this.filteredEnquiries.slice(startIndex, endIndex);

                if (enquiriesToShow.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-envelope fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No enquiries found</h5>
                            <p class="text-muted">Try adjusting your search criteria</p>
                        </div>
                    `;
                    return;
                }

                const html = enquiriesToShow.map(enquiry => {
                    const statusClass = {
                        'new': 'primary',
                        'in-progress': 'warning',
                        'resolved': 'success',
                        'closed': 'secondary'
                    }[enquiry.status];

                    const priorityClass = {
                        'urgent': 'danger',
                        'high': 'warning',
                        'medium': 'info',
                        'low': 'success'
                    }[enquiry.priority];

                    const timeAgo = this.getTimeAgo(enquiry.submittedAt);
                    const isSelected = this.selectedEnquiries.has(enquiry.id);

                    return `
                        <div class="card enquiry-card ${enquiry.priority} ${enquiry.status} mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-1">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   ${isSelected ? 'checked' : ''} 
                                                   onchange="toggleEnquirySelection(${enquiry.id})">
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">${enquiry.subject}</h6>
                                            <div class="d-flex gap-2">
                                                <span class="badge bg-${priorityClass} priority-badge">${enquiry.priority}</span>
                                                <span class="badge bg-${statusClass}">
                                                    <span class="status-indicator status-${enquiry.status}"></span>
                                                    ${enquiry.status}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-user"></i> ${enquiry.name} 
                                                <i class="fas fa-envelope ms-2"></i> ${enquiry.email}
                                                <i class="fas fa-phone ms-2"></i> ${enquiry.phone}
                                                <i class="fas fa-tag ms-2"></i> ${enquiry.category}
                                            </small>
                                        </div>
                                        <div class="enquiry-preview mb-2">
                                            ${enquiry.message}
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="fas fa-clock"></i> ${timeAgo}
                                                ${enquiry.assignedTo ? `<i class="fas fa-user-tag ms-2"></i> ${enquiry.assignedTo}` : ''}
                                                ${enquiry.attachments.length > 0 ? `<i class="fas fa-paperclip ms-2"></i> ${enquiry.attachments.length}` : ''}
                                            </small>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="viewEnquiry(${enquiry.id})">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                                <button class="btn btn-outline-success" onclick="quickResponse(${enquiry.id})">
                                                    <i class="fas fa-reply"></i> Reply
                                                </button>
                                                ${enquiry.status !== 'resolved' ? `
                                                    <button class="btn btn-outline-warning" onclick="updateEnquiryStatus(${enquiry.id}, 'resolved')">
                                                        <i class="fas fa-check"></i> Resolve
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-end">
                                            <div class="mb-2">
                                                <small class="text-muted">Source: ${enquiry.source}</small>
                                            </div>
                                            ${enquiry.responses.length > 0 ? `
                                                <div class="mb-2">
                                                    <small class="text-success">
                                                        <i class="fas fa-reply"></i> ${enquiry.responses.length} response(s)
                                                    </small>
                                                </div>
                                            ` : ''}
                                            <div class="progress" style="height: 4px;">
                                                <div class="progress-bar bg-${statusClass}" 
                                                     style="width: ${this.getProgressWidth(enquiry.status)}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
                this.renderPagination();
            }

            getProgressWidth(status) {
                const widths = {
                    'new': 25,
                    'in-progress': 50,
                    'resolved': 100,
                    'closed': 100
                };
                return widths[status] || 0;
            }

            getTimeAgo(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffInMinutes = Math.floor((now - date) / (1000 * 60));

                if (diffInMinutes < 60) {
                    return `${diffInMinutes}m ago`;
                } else if (diffInMinutes < 1440) {
                    return `${Math.floor(diffInMinutes / 60)}h ago`;
                } else {
                    return `${Math.floor(diffInMinutes / 1440)}d ago`;
                }
            }

            renderPagination() {
                const totalPages = Math.ceil(this.filteredEnquiries.length / this.itemsPerPage);
                const pagination = document.getElementById('pagination');

                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                let html = '';

                // Previous button
                html += `
                    <li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="enquiriesManager.changePage(${this.currentPage - 1})">Previous</a>
                    </li>
                `;

                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                        html += `
                            <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" onclick="enquiriesManager.changePage(${i})">${i}</a>
                            </li>
                        `;
                    } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
                        html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                    }
                }

                // Next button
                html += `
                    <li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="enquiriesManager.changePage(${this.currentPage + 1})">Next</a>
                    </li>
                `;

                pagination.innerHTML = html;
            }

            changePage(page) {
                const totalPages = Math.ceil(this.filteredEnquiries.length / this.itemsPerPage);
                if (page >= 1 && page <= totalPages) {
                    this.currentPage = page;
                    this.renderEnquiries();
                }
            }

            toggleEnquirySelection(enquiryId) {
                if (this.selectedEnquiries.has(enquiryId)) {
                    this.selectedEnquiries.delete(enquiryId);
                } else {
                    this.selectedEnquiries.add(enquiryId);
                }
                
                // Update select all checkbox
                const selectAllCheckbox = document.getElementById('selectAll');
                selectAllCheckbox.checked = this.selectedEnquiries.size === this.filteredEnquiries.length;
                selectAllCheckbox.indeterminate = this.selectedEnquiries.size > 0 && this.selectedEnquiries.size < this.filteredEnquiries.length;
            }

            updateStats() {
                const stats = this.enquiries.reduce((acc, enquiry) => {
                    acc[enquiry.status] = (acc[enquiry.status] || 0) + 1;
                    return acc;
                }, {});

                document.getElementById('newEnquiriesCount').textContent = stats.new || 0;
                document.getElementById('inProgressCount').textContent = stats['in-progress'] || 0;
                document.getElementById('resolvedCount').textContent = stats.resolved || 0;

                // Calculate average response time
                const responseTimes = this.enquiries
                    .filter(e => e.responses.length > 0)
                    .map(e => {
                        const submitted = new Date(e.submittedAt);
                        const firstResponse = new Date(e.responses[0].sentAt);
                        return (firstResponse - submitted) / (1000 * 60 * 60); // hours
                    });

                const avgResponseTime = responseTimes.length > 0 
                    ? Math.round(responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length * 10) / 10
                    : 0;

                document.getElementById('avgResponseTime').textContent = `${avgResponseTime}h`;
                document.getElementById('avgResponseDetail').textContent = `${avgResponseTime}h`;

                // Update other stats
                if (responseTimes.length > 0) {
                    const fastestResponse = Math.min(...responseTimes);
                    document.getElementById('fastestResponse').textContent = 
                        fastestResponse < 1 ? `${Math.round(fastestResponse * 60)}m` : `${Math.round(fastestResponse * 10) / 10}h`;
                }

                // Count overdue enquiries (>24h without response)
                const overdue = this.enquiries.filter(e => {
                    if (e.status === 'resolved' || e.status === 'closed') return false;
                    const submitted = new Date(e.submittedAt);
                    const now = new Date();
                    const hoursAgo = (now - submitted) / (1000 * 60 * 60);
                    return hoursAgo > 24 && e.responses.length === 0;
                }).length;

                document.getElementById('overdue').textContent = overdue;
            }

            renderCategoryChart() {
                const ctx = document.getElementById('categoryChart').getContext('2d');
                const categoryStats = this.enquiries.reduce((acc, enquiry) => {
                    acc[enquiry.category] = (acc[enquiry.category] || 0) + 1;
                    return acc;
                }, {});

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categoryStats).map(key => key.replace('-', ' ')),
                        datasets: [{
                            data: Object.values(categoryStats),
                            backgroundColor: [
                                '#007bff',
                                '#28a745',
                                '#ffc107',
                                '#dc3545',
                                '#17a2b8',
                                '#6f42c1'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            }

            viewEnquiry(enquiryId) {
                const enquiry = this.enquiries.find(e => e.id === enquiryId);
                if (!enquiry) return;

                this.currentEnquiryId = enquiryId;
                
                const modal = document.getElementById('enquiryDetailsModal');
                const title = document.getElementById('enquiryDetailsTitle');
                const content = document.getElementById('enquiryDetailsContent');

                title.textContent = enquiry.subject;

                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <div class="enquiry-details">
                                <h6><i class="fas fa-user"></i> Contact Information</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Name:</strong> ${enquiry.name}</p>
                                        <p><strong>Email:</strong> ${enquiry.email}</p>
                                        <p><strong>Phone:</strong> ${enquiry.phone}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Category:</strong> <span class="badge bg-light text-dark">${enquiry.category}</span></p>
                                        <p><strong>Priority:</strong> <span class="badge bg-warning">${enquiry.priority}</span></p>
                                        <p><strong>Status:</strong> <span class="badge bg-primary">${enquiry.status}</span></p>
                                    </div>
                                </div>
                            </div>

                            <div class="enquiry-details">
                                <h6><i class="fas fa-envelope"></i> Message</h6>
                                <p>${enquiry.message}</p>
                            </div>

                            ${enquiry.attachments.length > 0 ? `
                                <div class="enquiry-details">
                                    <h6><i class="fas fa-paperclip"></i> Attachments</h6>
                                    <div class="row">
                                        ${enquiry.attachments.map(attachment => `
                                            <div class="col-md-3 mb-2">
                                                <div class="card">
                                                    <div class="card-body text-center">
                                                        <i class="fas fa-file fa-2x mb-2"></i>
                                                        <p class="small mb-0">${attachment}</p>
                                                        <button class="btn btn-sm btn-outline-primary mt-1">
                                                            <i class="fas fa-download"></i> Download
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            <div class="enquiry-details">
                                <h6><i class="fas fa-history"></i> Response History</h6>
                                <div class="response-timeline">
                                    ${enquiry.responses.length > 0 ? enquiry.responses.map(response => `
                                        <div class="timeline-item response">
                                            <div class="d-flex justify-content-between">
                                                <strong>${response.sentBy}</strong>
                                                <small class="text-muted">${new Date(response.sentAt).toLocaleString()}</small>
                                            </div>
                                            <p class="mb-1">${response.message}</p>
                                            <small class="text-muted">
                                                <i class="fas fa-${response.type === 'email' ? 'envelope' : response.type === 'phone' ? 'phone' : 'sticky-note'}"></i>
                                                ${response.type}
                                            </small>
                                        </div>
                                    `).join('') : '<p class="text-muted">No responses yet</p>'}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6><i class="fas fa-info-circle"></i> Enquiry Details</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Submitted:</strong><br>${new Date(enquiry.submittedAt).toLocaleString()}</p>
                                    <p><strong>Last Updated:</strong><br>${new Date(enquiry.lastUpdated).toLocaleString()}</p>
                                    <p><strong>Source:</strong> ${enquiry.source}</p>
                                    ${enquiry.assignedTo ? `<p><strong>Assigned To:</strong> ${enquiry.assignedTo}</p>` : ''}
                                    ${enquiry.ipAddress ? `<p><strong>IP Address:</strong> ${enquiry.ipAddress}</p>` : ''}
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-tasks"></i> Quick Actions</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary btn-sm" onclick="showResponseModal()">
                                            <i class="fas fa-reply"></i> Send Response
                                        </button>
                                        <button class="btn btn-warning btn-sm" onclick="assignEnquiry()">
                                            <i class="fas fa-user-tag"></i> Assign
                                        </button>
                                        <button class="btn btn-info btn-sm" onclick="addNote()">
                                            <i class="fas fa-sticky-note"></i> Add Note
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="updateEnquiryStatus('resolved')">
                                            <i class="fas fa-check"></i> Mark Resolved
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                new bootstrap.Modal(modal).show();
            }

            showResponseModal() {
                const modal = document.getElementById('responseModal');
                document.getElementById('responseForm').reset();
                
                // Pre-fill subject if current enquiry is selected
                if (this.currentEnquiryId) {
                    const enquiry = this.enquiries.find(e => e.id === this.currentEnquiryId);
                    if (enquiry) {
                        document.getElementById('responseSubject').value = `Re: ${enquiry.subject}`;
                    }
                }
                
                new bootstrap.Modal(modal).show();
            }

            async sendResponse() {
                const form = document.getElementById('responseForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const responseData = {
                    type: document.getElementById('responseType').value,
                    subject: document.getElementById('responseSubject').value,
                    message: document.getElementById('responseMessage').value,
                    priority: document.getElementById('responsePriority').value,
                    markAsResolved: document.getElementById('markAsResolved').checked
                };

                try {
                    // Simulate API call
                    await fetch(`/api/enquiries/${this.currentEnquiryId}/responses`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(responseData)
                    });

                    // Update local data
                    const enquiry = this.enquiries.find(e => e.id === this.currentEnquiryId);
                    if (enquiry) {
                        enquiry.responses.push({
                            id: enquiry.responses.length + 1,
                            type: responseData.type,
                            message: responseData.message,
                            sentAt: new Date().toISOString(),
                            sentBy: 'Admin User'
                        });
                        enquiry.lastUpdated = new Date().toISOString();
                        enquiry.status = responseData.markAsResolved ? 'resolved' : 'in-progress';
                    }

                    bootstrap.Modal.getInstance(document.getElementById('responseModal')).hide();
                    
                    // Close details modal if open
                    const detailsModal = bootstrap.Modal.getInstance(document.getElementById('enquiryDetailsModal'));
                    if (detailsModal) detailsModal.hide();

                    this.showToast('Response sent successfully!', 'success');
                    this.renderEnquiries();
                    this.updateStats();

                } catch (error) {
                    this.showToast('Error sending response: ' + error.message, 'error');
                }
            }

            async updateEnquiryStatus(enquiryId, status) {
                if (typeof enquiryId === 'string') {
                    // Called from modal buttons
                    status = enquiryId;
                    enquiryId = this.currentEnquiryId;
                }

                try {
                    await fetch(`/api/enquiries/${enquiryId}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });

                    // Update local data
                    const enquiry = this.enquiries.find(e => e.id === enquiryId);
                    if (enquiry) {
                        enquiry.status = status;
                        enquiry.lastUpdated = new Date().toISOString();
                    }

                    this.showToast(`Enquiry marked as ${status}!`, 'success');
                    this.renderEnquiries();
                    this.updateStats();

                } catch (error) {
                    this.showToast('Error updating status: ' + error.message, 'error');
                }
            }

            bulkMarkResolved() {
                if (this.selectedEnquiries.size === 0) {
                    this.showToast('Please select enquiries to mark as resolved', 'warning');
                    return;
                }

                if (confirm(`Mark ${this.selectedEnquiries.size} enquiries as resolved?`)) {
                    this.selectedEnquiries.forEach(enquiryId => {
                        const enquiry = this.enquiries.find(e => e.id === enquiryId);
                        if (enquiry) {
                            enquiry.status = 'resolved';
                            enquiry.lastUpdated = new Date().toISOString();
                        }
                    });

                    this.selectedEnquiries.clear();
                    document.getElementById('selectAll').checked = false;
                    this.showToast('Enquiries marked as resolved!', 'success');
                    this.renderEnquiries();
                    this.updateStats();
                }
            }

            exportEnquiries() {
                const headers = ['Name', 'Email', 'Phone', 'Subject', 'Category', 'Priority', 'Status', 'Submitted', 'Source'];
                const csvContent = [
                    headers.join(','),
                    ...this.filteredEnquiries.map(enquiry => [
                        `"${enquiry.name}"`,
                        enquiry.email,
                        enquiry.phone,
                        `"${enquiry.subject}"`,
                        enquiry.category,
                        enquiry.priority,
                        enquiry.status,
                        enquiry.submittedAt,
                        enquiry.source
                    ].join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'enquiries.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }

            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                const toastHTML = `
                    <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header">
                            <i class="fas fa-${type === 'success' ? 'check-circle text-success' : 
                                              type === 'error' ? 'exclamation-circle text-danger' : 
                                              type === 'warning' ? 'exclamation-triangle text-warning' : 
                                              'info-circle text-info'}"></i>
                            <strong class="me-auto ms-2">Enquiries</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">${message}</div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                const toast = new bootstrap.Toast(document.getElementById(toastId));
                toast.show();
                
                // Remove toast element after it's hidden
                document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
                    this.remove();
                });
            }
        }

        // Global functions
        function viewEnquiry(enquiryId) {
            enquiriesManager.viewEnquiry(enquiryId);
        }

        function quickResponse(enquiryId) {
            enquiriesManager.currentEnquiryId = enquiryId;
            enquiriesManager.showResponseModal();
        }

        function updateEnquiryStatus(enquiryId, status) {
            enquiriesManager.updateEnquiryStatus(enquiryId, status);
        }

        function toggleEnquirySelection(enquiryId) {
            enquiriesManager.toggleEnquirySelection(enquiryId);
        }

        function showResponseModal() {
            enquiriesManager.showResponseModal();
        }

        function sendResponse() {
            enquiriesManager.sendResponse();
        }

        function bulkMarkResolved() {
            enquiriesManager.bulkMarkResolved();
        }

        function exportEnquiries() {
            enquiriesManager.exportEnquiries();
        }

        function saveDraft() {
            enquiriesManager.showToast('Draft saved successfully!', 'success');
        }

        function assignEnquiry() {
            enquiriesManager.showToast('Assignment feature coming soon!', 'info');
        }

        function addNote() {
            enquiriesManager.showToast('Note feature coming soon!', 'info');
        }

        function showBulkResponseModal() {
            enquiriesManager.showToast('Bulk response feature coming soon!', 'info');
        }

        function bulkAssignPriority() {
            enquiriesManager.showToast('Bulk priority assignment coming soon!', 'info');
        }

        function bulkCategorize() {
            enquiriesManager.showToast('Bulk categorization coming soon!', 'info');
        }

        function bulkArchive() {
            enquiriesManager.showToast('Bulk archive feature coming soon!', 'info');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '../../../index.html';
            }
        }

        // Initialize enquiries manager when DOM is loaded
        let enquiriesManager;
        document.addEventListener('DOMContentLoaded', function() {
            enquiriesManager = new EnquiriesManager();
        });
    </script>
</body>
</html>



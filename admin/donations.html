<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donations Management - BHRC Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
    <link href="assets/css/admin.css" rel="stylesheet">
    <style>
        .donations-header {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid;
        }
        .stat-card.total { border-left-color: #27ae60; }
        .stat-card.monthly { border-left-color: #3498db; }
        .stat-card.donors { border-left-color: #9b59b6; }
        .stat-card.pending { border-left-color: #f39c12; }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        .donations-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .donation-card {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
        }
        .donation-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .donation-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status-completed {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }
        .status-pending {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
        }
        .status-failed {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }
        .status-refunded {
            background: rgba(149, 165, 166, 0.1);
            color: #95a5a6;
        }
        .donation-amount {
            background: #27ae60;
            color: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-right: 20px;
            min-width: 100px;
        }
        .donation-amount .currency {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        .donation-amount .amount {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }
        .donation-content {
            flex: 1;
        }
        .donor-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .donation-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        .donation-meta i {
            width: 16px;
            margin-right: 5px;
        }
        .donation-purpose {
            color: #5a6c7d;
            margin-bottom: 15px;
        }
        .donation-actions {
            display: flex;
            gap: 10px;
        }
        .btn-action {
            padding: 5px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        .btn-view {
            background: #3498db;
            color: white;
        }
        .btn-receipt {
            background: #27ae60;
            color: white;
        }
        .btn-refund {
            background: #e74c3c;
            color: white;
        }
        .btn-action:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        .filters-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .donor-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-right: 8px;
        }
        .type-individual {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }
        .type-organization {
            background: rgba(155, 89, 182, 0.1);
            color: #9b59b6;
        }
        .type-corporate {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
        }
        .type-anonymous {
            background: rgba(149, 165, 166, 0.1);
            color: #95a5a6;
        }
        .payment-method {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .payment-icon {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        .recent-donors {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .donor-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        .donor-item:last-child {
            border-bottom: none;
        }
        .donor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .donor-info {
            flex: 1;
        }
        .donor-info .name {
            font-weight: 600;
            color: #2c3e50;
        }
        .donor-info .amount {
            color: #27ae60;
            font-weight: 500;
        }
        .donor-info .date {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        .export-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .bulk-actions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        .bulk-actions.show {
            display: block;
        }
        .donation-checkbox {
            margin-right: 15px;
        }
        .tax-info {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="../../images/logo-light.png" alt="BHRC" class="sidebar-logo">
                <h4>BHRC Admin</h4>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="complaints.html" class="nav-link">
                    <i class="fas fa-exclamation-triangle"></i> Complaints
                </a>
                <a href="events.html" class="nav-link">
                    <i class="fas fa-calendar-alt"></i> Events
                </a>
                <a href="activities.html" class="nav-link">
                    <i class="fas fa-tasks"></i> Activities
                </a>
                <a href="members.html" class="nav-link">
                    <i class="fas fa-users"></i> Members
                </a>
                <a href="add_member.html" class="nav-link">
                    <i class="fas fa-user-plus"></i> Add Member
                </a>
                <a href="donations.html" class="nav-link active">
                    <i class="fas fa-heart"></i> Donations
                </a>
                <a href="gallery.html" class="nav-link">
                    <i class="fas fa-images"></i> Gallery
                </a>
                <a href="achievements.html" class="nav-link">
                    <i class="fas fa-trophy"></i> Achievements
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="admin-header">
                <div class="header-left">
                    <button class="sidebar-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Donations Management</h1>
                </div>
                <div class="header-right">
                    <div class="header-actions">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDonationModal">
                            <i class="fas fa-plus"></i> Add Donation
                        </button>
                        <div class="user-menu dropdown">
                            <button class="user-avatar dropdown-toggle" data-bs-toggle="dropdown">
                                <img src="../../images/default-avatar.png" alt="User">
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#"><i class="fas fa-user"></i> Profile</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-cog"></i> Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Page Header -->
                <div class="donations-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2><i class="fas fa-heart"></i> Donations Management</h2>
                            <p class="mb-0">Track and manage donations received by BHRC</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-light" onclick="refreshDonations()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="stats-row">
                    <div class="stat-card total">
                        <div class="stat-number" id="totalDonations">â‚¹0</div>
                        <div class="stat-label">Total Donations</div>
                    </div>
                    <div class="stat-card monthly">
                        <div class="stat-number" id="monthlyDonations">â‚¹0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                    <div class="stat-card donors">
                        <div class="stat-number" id="totalDonors">0</div>
                        <div class="stat-label">Total Donors</div>
                    </div>
                    <div class="stat-card pending">
                        <div class="stat-number" id="pendingDonations">â‚¹0</div>
                        <div class="stat-label">Pending Amount</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-container">
                        <div class="chart-title">Monthly Donations Trend</div>
                        <canvas id="donationsChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Donation Sources</div>
                        <canvas id="sourcesChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters-section">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Search Donations</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchInput" placeholder="Search by donor name...">
                                    <button class="btn btn-outline-secondary" onclick="searchDonations()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Status</label>
                                <select class="form-select" id="statusFilter" onchange="filterDonations()">
                                    <option value="">All Status</option>
                                    <option value="completed">Completed</option>
                                    <option value="pending">Pending</option>
                                    <option value="failed">Failed</option>
                                    <option value="refunded">Refunded</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Donor Type</label>
                                <select class="form-select" id="typeFilter" onchange="filterDonations()">
                                    <option value="">All Types</option>
                                    <option value="individual">Individual</option>
                                    <option value="organization">Organization</option>
                                    <option value="corporate">Corporate</option>
                                    <option value="anonymous">Anonymous</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Amount Range</label>
                                <select class="form-select" id="amountFilter" onchange="filterDonations()">
                                    <option value="">All Amounts</option>
                                    <option value="0-1000">â‚¹0 - â‚¹1,000</option>
                                    <option value="1000-5000">â‚¹1,000 - â‚¹5,000</option>
                                    <option value="5000-10000">â‚¹5,000 - â‚¹10,000</option>
                                    <option value="10000+">â‚¹10,000+</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <div class="export-section">
                                    <button class="btn btn-outline-primary" onclick="clearFilters()">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                    <button class="btn btn-outline-success" onclick="exportDonations()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                    <button class="btn btn-outline-info" onclick="generateReport()">
                                        <i class="fas fa-chart-bar"></i> Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="bulk-actions" id="bulkActions">
                    <div class="d-flex align-items-center justify-content-between">
                        <span><span id="selectedCount">0</span> donations selected</span>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-success" onclick="bulkGenerateReceipts()">
                                <i class="fas fa-receipt"></i> Generate Receipts
                            </button>
                            <button class="btn btn-sm btn-info" onclick="bulkSendThankYou()">
                                <i class="fas fa-envelope"></i> Send Thank You
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="clearSelection()">
                                <i class="fas fa-times"></i> Clear Selection
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Donations List -->
                <div class="donations-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Recent Donations</h5>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <label class="form-check-label" for="selectAll">Select All</label>
                        </div>
                    </div>
                    
                    <div id="donationsListContainer">
                        <!-- Donations will be loaded here -->
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Donations pagination" class="mt-4">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination will be generated here -->
                        </ul>
                    </nav>
                </div>

                <!-- Recent Donors -->
                <div class="recent-donors">
                    <h5 class="mb-3">Top Donors This Month</h5>
                    <div id="topDonorsList">
                        <!-- Top donors will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Donation Modal -->
    <div class="modal fade" id="addDonationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="donationModalTitle">Add New Donation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="donationForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="donorName" class="form-label">Donor Name *</label>
                                    <input type="text" class="form-control" id="donorName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="donorType" class="form-label">Donor Type *</label>
                                    <select class="form-select" id="donorType" required>
                                        <option value="">Select Type</option>
                                        <option value="individual">Individual</option>
                                        <option value="organization">Organization</option>
                                        <option value="corporate">Corporate</option>
                                        <option value="anonymous">Anonymous</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="donationAmount" class="form-label">Amount (â‚¹) *</label>
                                    <input type="number" class="form-control" id="donationAmount" min="1" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="paymentMethod" class="form-label">Payment Method *</label>
                                    <select class="form-select" id="paymentMethod" required>
                                        <option value="">Select Method</option>
                                        <option value="online">Online Payment</option>
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="cheque">Cheque</option>
                                        <option value="cash">Cash</option>
                                        <option value="upi">UPI</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="donationPurpose" class="form-label">Purpose/Cause</label>
                            <textarea class="form-control" id="donationPurpose" rows="3" placeholder="General donation, Legal aid, Education, etc."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="donorEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="donorEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="donorPhone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="donorPhone">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="donorAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="donorAddress" rows="2"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="transactionId" class="form-label">Transaction ID</label>
                                    <input type="text" class="form-control" id="transactionId">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="donationStatus" class="form-label">Status</label>
                                    <select class="form-select" id="donationStatus">
                                        <option value="completed">Completed</option>
                                        <option value="pending">Pending</option>
                                        <option value="failed">Failed</option>
                                        <option value="refunded">Refunded</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="taxExemption">
                            <label class="form-check-label" for="taxExemption">
                                Eligible for Tax Exemption (80G)
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="sendReceipt">
                            <label class="form-check-label" for="sendReceipt">
                                Send Receipt to Donor
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveDonation()">Save Donation</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Donation Details Modal -->
    <div class="modal fade" id="donationDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Donation Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="donationDetailsContent">
                    <!-- Donation details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="generateReceipt()">Generate Receipt</button>
                    <button type="button" class="btn btn-primary" onclick="editCurrentDonation()">Edit Donation</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="assets/js/admin.js"></script>
    <script>
        class DonationsManager {
            constructor() {
                this.donations = [];
                this.filteredDonations = [];
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.selectedDonations = new Set();
                this.currentDonationId = null;
                this.charts = {};
                this.init();
            }

            async init() {
                await this.loadDonations();
                this.updateStats();
                this.renderDonationsList();
                this.renderTopDonors();
                this.initializeCharts();
                this.setupEventListeners();
            }

            async loadDonations() {
                try {
                    const response = await fetch(window.BHRC_CONFIG ? window.BHRC_CONFIG.API.BASE_URL + ''.replace('/api', '') : 'https://bhrcdata.online/backend/api'.replace('/api', '')));
                    const result = await response.json();
                    
                    if (result.success) {
                        this.donations = result.data;
                        this.filteredDonations = [...this.donations];
                    } else {
                        this.showToast('Error loading donations: ' + result.message, 'error');
                        this.loadSampleData();
                    }
                } catch (error) {
                    this.showToast('Error loading donations: ' + error.message, 'error');
                    this.loadSampleData();
                }
            }

            loadSampleData() {
                this.donations = [
                    {
                        id: 1,
                        donorName: 'Rajesh Kumar',
                        donorType: 'individual',
                        amount: 5000,
                        purpose: 'Legal aid for underprivileged',
                        email: 'rajesh@example.com',
                        phone: '+91 9876543210',
                        address: 'Patna, Bharatiya',
                        paymentMethod: 'online',
                        transactionId: 'TXN123456789',
                        status: 'completed',
                        date: '2024-02-10T10:30:00',
                        taxExemption: true,
                        receiptSent: true
                    },
                    {
                        id: 2,
                        donorName: 'Priya Sharma Foundation',
                        donorType: 'organization',
                        amount: 25000,
                        purpose: 'Human rights awareness programs',
                        email: 'contact@priyafoundation.org',
                        phone: '+91 9876543211',
                        address: 'New Delhi',
                        paymentMethod: 'bank_transfer',
                        transactionId: 'TXN123456790',
                        status: 'completed',
                        date: '2024-02-08T14:15:00',
                        taxExemption: true,
                        receiptSent: true
                    },
                    {
                        id: 3,
                        donorName: 'Anonymous Donor',
                        donorType: 'anonymous',
                        amount: 2000,
                        purpose: 'General donation',
                        email: '',
                        phone: '',
                        address: '',
                        paymentMethod: 'upi',
                        transactionId: 'TXN123456791',
                        status: 'completed',
                        date: '2024-02-12T16:45:00',
                        taxExemption: false,
                        receiptSent: false
                    },
                    {
                        id: 4,
                        donorName: 'Tech Solutions Pvt Ltd',
                        donorType: 'corporate',
                        amount: 50000,
                        purpose: 'Education and legal awareness',
                        email: 'csr@techsolutions.com',
                        phone: '+91 9876543212',
                        address: 'Mumbai, Maharashtra',
                        paymentMethod: 'cheque',
                        transactionId: 'CHQ001234',
                        status: 'pending',
                        date: '2024-02-14T11:20:00',
                        taxExemption: true,
                        receiptSent: false
                    }
                ];
                this.filteredDonations = [...this.donations];
            }

            updateStats() {
                const totalAmount = this.donations.reduce((sum, d) => sum + (d.status === 'completed' ? d.amount : 0), 0);
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthlyAmount = this.donations
                    .filter(d => {
                        const donationDate = new Date(d.date);
                        return donationDate.getMonth() === currentMonth && 
                               donationDate.getFullYear() === currentYear &&
                               d.status === 'completed';
                    })
                    .reduce((sum, d) => sum + d.amount, 0);
                
                const uniqueDonors = new Set(this.donations.map(d => d.donorName)).size;
                const pendingAmount = this.donations.reduce((sum, d) => sum + (d.status === 'pending' ? d.amount : 0), 0);

                document.getElementById('totalDonations').textContent = 'â‚¹' + totalAmount.toLocaleString();
                document.getElementById('monthlyDonations').textContent = 'â‚¹' + monthlyAmount.toLocaleString();
                document.getElementById('totalDonors').textContent = uniqueDonors;
                document.getElementById('pendingDonations').textContent = 'â‚¹' + pendingAmount.toLocaleString();
            }

            renderDonationsList() {
                const container = document.getElementById('donationsListContainer');
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const pageDonations = this.filteredDonations.slice(startIndex, endIndex);

                container.innerHTML = pageDonations.map(donation => {
                    const donationDate = new Date(donation.date);
                    
                    return `
                        <div class="donation-card">
                            <div class="donation-status status-${donation.status}">
                                ${donation.status.charAt(0).toUpperCase() + donation.status.slice(1)}
                            </div>
                            <div class="d-flex">
                                <input type="checkbox" class="donation-checkbox" value="${donation.id}" onchange="toggleDonationSelection(${donation.id})">
                                <div class="donation-amount">
                                    <span class="currency">â‚¹</span>
                                    <span class="amount">${donation.amount.toLocaleString()}</span>
                                </div>
                                <div class="donation-content">
                                    <div class="donor-name">${donation.donorName}</div>
                                    <div class="donation-meta">
                                        <span><i class="fas fa-calendar"></i> ${donationDate.toLocaleDateString()}</span>
                                        <span><i class="fas fa-clock"></i> ${donationDate.toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit' })}</span>
                                        <span class="payment-method">
                                            <i class="fas fa-credit-card"></i> ${donation.paymentMethod.replace('_', ' ').toUpperCase()}
                                        </span>
                                        <span><i class="fas fa-hashtag"></i> ${donation.transactionId}</span>
                                    </div>
                                    <div class="donor-type-badge type-${donation.donorType}">
                                        ${donation.donorType.charAt(0).toUpperCase() + donation.donorType.slice(1)}
                                    </div>
                                    <div class="donation-purpose">${donation.purpose}</div>
                                    ${donation.taxExemption ? '<div class="tax-info"><i class="fas fa-receipt"></i> Eligible for 80G Tax Exemption</div>' : ''}
                                    <div class="donation-actions">
                                        <button class="btn-action btn-view" onclick="viewDonation(${donation.id})" title="View Details">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button class="btn-action btn-receipt" onclick="generateReceipt(${donation.id})" title="Generate Receipt">
                                            <i class="fas fa-receipt"></i> Receipt
                                        </button>
                                        ${donation.status === 'completed' ? `
                                            <button class="btn-action btn-refund" onclick="processRefund(${donation.id})" title="Process Refund">
                                                <i class="fas fa-undo"></i> Refund
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                this.renderPagination();
            }

            renderPagination() {
                const totalPages = Math.ceil(this.filteredDonations.length / this.itemsPerPage);
                const pagination = document.getElementById('pagination');
                
                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                let paginationHTML = '';
                
                // Previous button
                paginationHTML += `
                    <li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${this.currentPage - 1})">Previous</a>
                    </li>
                `;

                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                        paginationHTML += `
                            <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                            </li>
                        `;
                    } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
                        paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                    }
                }

                // Next button
                paginationHTML += `
                    <li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${this.currentPage + 1})">Next</a>
                    </li>
                `;

                pagination.innerHTML = paginationHTML;
            }

            renderTopDonors() {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                const monthlyDonors = this.donations
                    .filter(d => {
                        const donationDate = new Date(d.date);
                        return donationDate.getMonth() === currentMonth && 
                               donationDate.getFullYear() === currentYear &&
                               d.status === 'completed';
                    })
                    .sort((a, b) => b.amount - a.amount)
                    .slice(0, 5);

                const container = document.getElementById('topDonorsList');
                container.innerHTML = monthlyDonors.map(donation => `
                    <div class="donor-item">
                        <img src="../../images/default-avatar.png" alt="Donor" class="donor-avatar">
                        <div class="donor-info">
                            <div class="name">${donation.donorName}</div>
                            <div class="amount">â‚¹${donation.amount.toLocaleString()}</div>
                            <div class="date">${new Date(donation.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                `).join('');
            }

            initializeCharts() {
                this.initializeDonationsChart();
                this.initializeSourcesChart();
            }

            initializeDonationsChart() {
                const ctx = document.getElementById('donationsChart').getContext('2d');
                
                // Generate monthly data for the last 6 months
                const monthlyData = this.generateMonthlyData();
                
                this.charts.donations = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: monthlyData.labels,
                        datasets: [{
                            label: 'Donations (â‚¹)',
                            data: monthlyData.amounts,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'â‚¹' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            initializeSourcesChart() {
                const ctx = document.getElementById('sourcesChart').getContext('2d');
                
                const sourceData = this.generateSourceData();
                
                this.charts.sources = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sourceData.labels,
                        datasets: [{
                            data: sourceData.amounts,
                            backgroundColor: [
                                '#3498db',
                                '#9b59b6',
                                '#f39c12',
                                '#95a5a6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            generateMonthlyData() {
                const months = [];
                const amounts = [];
                const now = new Date();
                
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const monthName = date.toLocaleDateString('en', { month: 'short' });
                    months.push(monthName);
                    
                    const monthlyAmount = this.donations
                        .filter(d => {
                            const donationDate = new Date(d.date);
                            return donationDate.getMonth() === date.getMonth() && 
                                   donationDate.getFullYear() === date.getFullYear() &&
                                   d.status === 'completed';
                        })
                        .reduce((sum, d) => sum + d.amount, 0);
                    
                    amounts.push(monthlyAmount);
                }
                
                return { labels: months, amounts: amounts };
            }

            generateSourceData() {
                const sources = {};
                this.donations
                    .filter(d => d.status === 'completed')
                    .forEach(d => {
                        sources[d.donorType] = (sources[d.donorType] || 0) + d.amount;
                    });
                
                return {
                    labels: Object.keys(sources).map(key => key.charAt(0).toUpperCase() + key.slice(1)),
                    amounts: Object.values(sources)
                };
            }

            setupEventListeners() {
                document.getElementById('searchInput').addEventListener('input', () => {
                    this.searchDonations();
                });
            }

            searchDonations() {
                const query = document.getElementById('searchInput').value.toLowerCase();
                this.filteredDonations = this.donations.filter(donation => 
                    donation.donorName.toLowerCase().includes(query) ||
                    donation.purpose.toLowerCase().includes(query) ||
                    donation.transactionId.toLowerCase().includes(query)
                );
                this.currentPage = 1;
                this.renderDonationsList();
            }

            filterDonations() {
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                const amountFilter = document.getElementById('amountFilter').value;

                this.filteredDonations = this.donations.filter(donation => {
                    let matchesStatus = !statusFilter || donation.status === statusFilter;
                    let matchesType = !typeFilter || donation.donorType === typeFilter;
                    let matchesAmount = true;
                    
                    if (amountFilter) {
                        if (amountFilter === '0-1000') {
                            matchesAmount = donation.amount <= 1000;
                        } else if (amountFilter === '1000-5000') {
                            matchesAmount = donation.amount > 1000 && donation.amount <= 5000;
                        } else if (amountFilter === '5000-10000') {
                            matchesAmount = donation.amount > 5000 && donation.amount <= 10000;
                        } else if (amountFilter === '10000+') {
                            matchesAmount = donation.amount > 10000;
                        }
                    }
                    
                    return matchesStatus && matchesType && matchesAmount;
                });

                this.currentPage = 1;
                this.renderDonationsList();
            }

            clearFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('statusFilter').value = '';
                document.getElementById('typeFilter').value = '';
                document.getElementById('amountFilter').value = '';
                this.filteredDonations = [...this.donations];
                this.currentPage = 1;
                this.renderDonationsList();
            }

            changePage(page) {
                const totalPages = Math.ceil(this.filteredDonations.length / this.itemsPerPage);
                if (page >= 1 && page <= totalPages) {
                    this.currentPage = page;
                    this.renderDonationsList();
                }
            }

            toggleDonationSelection(donationId) {
                if (this.selectedDonations.has(donationId)) {
                    this.selectedDonations.delete(donationId);
                } else {
                    this.selectedDonations.add(donationId);
                }
                
                this.updateBulkActions();
            }

            toggleSelectAll() {
                const selectAll = document.getElementById('selectAll').checked;
                const checkboxes = document.querySelectorAll('.donation-checkbox');
                
                if (selectAll) {
                    checkboxes.forEach(cb => {
                        cb.checked = true;
                        this.selectedDonations.add(parseInt(cb.value));
                    });
                } else {
                    checkboxes.forEach(cb => {
                        cb.checked = false;
                        this.selectedDonations.delete(parseInt(cb.value));
                    });
                }
                
                this.updateBulkActions();
            }

            updateBulkActions() {
                const bulkActions = document.getElementById('bulkActions');
                const selectedCount = document.getElementById('selectedCount');
                
                selectedCount.textContent = this.selectedDonations.size;
                
                if (this.selectedDonations.size > 0) {
                    bulkActions.classList.add('show');
                } else {
                    bulkActions.classList.remove('show');
                }
            }

            clearSelection() {
                this.selectedDonations.clear();
                document.querySelectorAll('.donation-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('selectAll').checked = false;
                this.updateBulkActions();
            }

            viewDonation(donationId) {
                const donation = this.donations.find(d => d.id === donationId);
                if (!donation) return;

                this.currentDonationId = donationId;
                const donationDate = new Date(donation.date);

                const modalContent = document.getElementById('donationDetailsContent');
                modalContent.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <h4>Donation from ${donation.donorName}</h4>
                            <div class="mb-3">
                                <span class="donor-type-badge type-${donation.donorType}">${donation.donorType.charAt(0).toUpperCase() + donation.donorType.slice(1)}</span>
                                <span class="donation-status status-${donation.status}">${donation.status.charAt(0).toUpperCase() + donation.status.slice(1)}</span>
                            </div>
                            
                            <h6>Donation Details</h6>
                            <table class="table table-borderless">
                                <tr><td><strong>Amount:</strong></td><td>â‚¹${donation.amount.toLocaleString()}</td></tr>
                                <tr><td><strong>Purpose:</strong></td><td>${donation.purpose}</td></tr>
                                <tr><td><strong>Date & Time:</strong></td><td>${donationDate.toLocaleDateString()} ${donationDate.toLocaleTimeString()}</td></tr>
                                <tr><td><strong>Payment Method:</strong></td><td>${donation.paymentMethod.replace('_', ' ').toUpperCase()}</td></tr>
                                <tr><td><strong>Transaction ID:</strong></td><td>${donation.transactionId}</td></tr>
                                <tr><td><strong>Tax Exemption:</strong></td><td>${donation.taxExemption ? 'Yes (80G)' : 'No'}</td></tr>
                                <tr><td><strong>Receipt Sent:</strong></td><td>${donation.receiptSent ? 'Yes' : 'No'}</td></tr>
                            </table>
                            
                            ${donation.email || donation.phone || donation.address ? `
                                <h6>Contact Information</h6>
                                <table class="table table-borderless">
                                    ${donation.email ? `<tr><td><strong>Email:</strong></td><td>${donation.email}</td></tr>` : ''}
                                    ${donation.phone ? `<tr><td><strong>Phone:</strong></td><td>${donation.phone}</td></tr>` : ''}
                                    ${donation.address ? `<tr><td><strong>Address:</strong></td><td>${donation.address}</td></tr>` : ''}
                                </table>
                            ` : ''}
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Quick Actions</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success btn-sm" onclick="generateReceipt(${donation.id})">
                                            <i class="fas fa-receipt"></i> Generate Receipt
                                        </button>
                                        <button class="btn btn-info btn-sm" onclick="sendThankYou(${donation.id})">
                                            <i class="fas fa-envelope"></i> Send Thank You
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="editDonation(${donation.id})">
                                            <i class="fas fa-edit"></i> Edit Donation
                                        </button>
                                        ${donation.status === 'completed' ? `
                                            <button class="btn btn-warning btn-sm" onclick="processRefund(${donation.id})">
                                                <i class="fas fa-undo"></i> Process Refund
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const modal = new bootstrap.Modal(document.getElementById('donationDetailsModal'));
                modal.show();
            }

            async saveDonation() {
                const form = document.getElementById('donationForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const donationData = {
                    donorName: document.getElementById('donorName').value,
                    donorType: document.getElementById('donorType').value,
                    amount: parseFloat(document.getElementById('donationAmount').value),
                    purpose: document.getElementById('donationPurpose').value,
                    email: document.getElementById('donorEmail').value,
                    phone: document.getElementById('donorPhone').value,
                    address: document.getElementById('donorAddress').value,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    transactionId: document.getElementById('transactionId').value,
                    status: document.getElementById('donationStatus').value,
                    taxExemption: document.getElementById('taxExemption').checked,
                    receiptSent: document.getElementById('sendReceipt').checked,
                    date: new Date().toISOString()
                };

                try {
                    let response;
                    if (this.currentDonationId) {
                        // Update existing donation
                        response = await fetch(`/api/donations/${this.currentDonationId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(donationData)
                        });
                    } else {
                        // Create new donation
                        response = await fetch(window.BHRC_CONFIG ? window.BHRC_CONFIG.API.BASE_URL + ''.replace('/api', '') : 'https://bhrcdata.online/backend/api'.replace('/api', '')), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(donationData)
                        });
                    }

                    const result = await response.json();
                    if (result.success) {
                        this.showToast(this.currentDonationId ? 'Donation updated successfully' : 'Donation added successfully', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('addDonationModal')).hide();
                        await this.loadDonations();
                        this.updateStats();
                        this.renderDonationsList();
                        this.renderTopDonors();
                        this.updateCharts();
                    } else {
                        this.showToast('Error saving donation: ' + result.message, 'error');
                    }
                } catch (error) {
                    this.showToast('Error saving donation: ' + error.message, 'error');
                    // For demo purposes, simulate success
                    this.showToast(this.currentDonationId ? 'Donation updated successfully' : 'Donation added successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addDonationModal')).hide();
                }
            }

            updateCharts() {
                if (this.charts.donations) {
                    const monthlyData = this.generateMonthlyData();
                    this.charts.donations.data.labels = monthlyData.labels;
                    this.charts.donations.data.datasets[0].data = monthlyData.amounts;
                    this.charts.donations.update();
                }
                
                if (this.charts.sources) {
                    const sourceData = this.generateSourceData();
                    this.charts.sources.data.labels = sourceData.labels;
                    this.charts.sources.data.datasets[0].data = sourceData.amounts;
                    this.charts.sources.update();
                }
            }

            exportDonations() {
                const csv = this.convertToCSV(this.filteredDonations);
                this.downloadCSV(csv, 'donations.csv');
                this.showToast('Donations data exported successfully', 'success');
            }

            convertToCSV(data) {
                const headers = ['ID', 'Donor Name', 'Type', 'Amount', 'Purpose', 'Date', 'Payment Method', 'Transaction ID', 'Status', 'Email', 'Phone'];
                const csvContent = [
                    headers.join(','),
                    ...data.map(donation => [
                        donation.id,
                        `"${donation.donorName}"`,
                        donation.donorType,
                        donation.amount,
                        `"${donation.purpose}"`,
                        donation.date,
                        donation.paymentMethod,
                        donation.transactionId,
                        donation.status,
                        donation.email || '',
                        donation.phone || ''
                    ].join(','))
                ].join('\n');
                
                return csvContent;
            }

            downloadCSV(csv, filename) {
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('hidden', '');
                a.setAttribute('href', url);
                a.setAttribute('download', filename);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                const toastHTML = `
                    <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0" role="alert">
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                const toast = new bootstrap.Toast(document.getElementById(toastId));
                toast.show();
                
                document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
                    this.remove();
                });
            }
        }

        // Global functions
        let donationsManager;

        function changePage(page) {
            donationsManager.changePage(page);
        }

        function searchDonations() {
            donationsManager.searchDonations();
        }

        function filterDonations() {
            donationsManager.filterDonations();
        }

        function clearFilters() {
            donationsManager.clearFilters();
        }

        function toggleDonationSelection(donationId) {
            donationsManager.toggleDonationSelection(donationId);
        }

        function toggleSelectAll() {
            donationsManager.toggleSelectAll();
        }

        function clearSelection() {
            donationsManager.clearSelection();
        }

        function viewDonation(donationId) {
            donationsManager.viewDonation(donationId);
        }

        function editCurrentDonation() {
            if (donationsManager.currentDonationId) {
                bootstrap.Modal.getInstance(document.getElementById('donationDetailsModal')).hide();
                editDonation(donationsManager.currentDonationId);
            }
        }

        function editDonation(donationId) {
            const donation = donationsManager.donations.find(d => d.id === donationId);
            if (!donation) return;

            donationsManager.currentDonationId = donationId;
            document.getElementById('donationModalTitle').textContent = 'Edit Donation';
            
            // Populate form fields
            document.getElementById('donorName').value = donation.donorName;
            document.getElementById('donorType').value = donation.donorType;
            document.getElementById('donationAmount').value = donation.amount;
            document.getElementById('donationPurpose').value = donation.purpose;
            document.getElementById('donorEmail').value = donation.email;
            document.getElementById('donorPhone').value = donation.phone;
            document.getElementById('donorAddress').value = donation.address;
            document.getElementById('paymentMethod').value = donation.paymentMethod;
            document.getElementById('transactionId').value = donation.transactionId;
            document.getElementById('donationStatus').value = donation.status;
            document.getElementById('taxExemption').checked = donation.taxExemption;
            document.getElementById('sendReceipt').checked = donation.receiptSent;

            const modal = new bootstrap.Modal(document.getElementById('addDonationModal'));
            modal.show();
        }

        function saveDonation() {
            donationsManager.saveDonation();
        }

        function generateReceipt(donationId) {
            donationsManager.showToast('Receipt generated and sent to donor', 'success');
        }

        function sendThankYou(donationId) {
            donationsManager.showToast('Thank you message sent to donor', 'success');
        }

        function processRefund(donationId) {
            if (confirm('Are you sure you want to process a refund for this donation?')) {
                donationsManager.showToast('Refund processed successfully', 'success');
            }
        }

        function bulkGenerateReceipts() {
            donationsManager.showToast(`Receipts generated for ${donationsManager.selectedDonations.size} donations`, 'success');
        }

        function bulkSendThankYou() {
            donationsManager.showToast(`Thank you messages sent for ${donationsManager.selectedDonations.size} donations`, 'success');
        }

        function exportDonations() {
            donationsManager.exportDonations();
        }

        function generateReport() {
            donationsManager.showToast('Donation report generated successfully', 'success');
        }

        function refreshDonations() {
            donationsManager.loadDonations().then(() => {
                donationsManager.updateStats();
                donationsManager.renderDonationsList();
                donationsManager.renderTopDonors();
                donationsManager.updateCharts();
                donationsManager.showToast('Donations data refreshed', 'success');
            });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '../login.html';
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            donationsManager = new DonationsManager();
            
            // Reset form when modal is hidden
            document.getElementById('addDonationModal').addEventListener('hidden.bs.modal', function() {
                document.getElementById('donationForm').reset();
                document.getElementById('donationModalTitle').textContent = 'Add New Donation';
                donationsManager.currentDonationId = null;
            });
        });
    </script>
</body>
</html>



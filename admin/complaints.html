<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complaints Management - BHRC Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/admin.css" rel="stylesheet">
    <style>
        .complaints-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 5px solid;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card.pending { border-left-color: #ffc107; }
        .stat-card.in-progress { border-left-color: #17a2b8; }
        .stat-card.resolved { border-left-color: #28a745; }
        .stat-card.rejected { border-left-color: #dc3545; }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .filters-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .complaints-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .table-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        .complaint-row {
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .complaint-row:hover {
            background-color: rgba(0,123,255,0.05);
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-in-progress { background: #d1ecf1; color: #0c5460; }
        .status-resolved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .priority-high { color: #dc3545; }
        .priority-medium { color: #ffc107; }
        .priority-low { color: #28a745; }
        .complaint-details {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .detail-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        .detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid white;
        }
        .timeline-date {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 5px;
        }
        .timeline-content {
            font-size: 0.9rem;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .complaint-attachments {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .attachment-item {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }
        .attachment-item:hover {
            border-color: #007bff;
            background: rgba(0,123,255,0.05);
        }
        .attachment-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #007bff;
        }
        .quick-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
        .fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            border: none;
            box-shadow: 0 5px 20px rgba(0,123,255,0.3);
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        .fab:hover {
            background: #0056b3;
            transform: scale(1.1);
        }
        .response-form {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .bulk-actions {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        .complaint-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            border-left: 5px solid;
            transition: all 0.3s;
        }
        .complaint-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
        }
        .complaint-card.pending { border-left-color: #ffc107; }
        .complaint-card.in-progress { border-left-color: #17a2b8; }
        .complaint-card.resolved { border-left-color: #28a745; }
        .complaint-card.rejected { border-left-color: #dc3545; }
        .complaint-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .complaint-meta {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 10px;
        }
        .complaint-description {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .complaint-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="../../images/logo-light.png" alt="BHRC" class="sidebar-logo">
                <h4>BHRC Admin</h4>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="complaints.html" class="nav-link active">
                    <i class="fas fa-exclamation-triangle"></i> Complaints
                </a>
                <a href="events.html" class="nav-link">
                    <i class="fas fa-calendar-alt"></i> Events
                </a>
                <a href="activities.html" class="nav-link">
                    <i class="fas fa-tasks"></i> Activities
                </a>
                <a href="members.html" class="nav-link">
                    <i class="fas fa-users"></i> Members
                </a>
                <a href="add_member.html" class="nav-link">
                    <i class="fas fa-user-plus"></i> Add Member
                </a>
                <a href="donations.html" class="nav-link">
                    <i class="fas fa-heart"></i> Donations
                </a>
                <a href="gallery.html" class="nav-link">
                    <i class="fas fa-images"></i> Gallery
                </a>
                <a href="achievements.html" class="nav-link">
                    <i class="fas fa-trophy"></i> Achievements
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="admin-header">
                <div class="header-left">
                    <button class="sidebar-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Complaints Management</h1>
                </div>
                <div class="header-right">
                    <div class="header-actions">
                        <button class="btn btn-outline-primary" onclick="exportComplaints()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <div class="user-menu dropdown">
                            <button class="user-avatar dropdown-toggle" data-bs-toggle="dropdown">
                                <img src="../../images/default-avatar.png" alt="User">
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#"><i class="fas fa-user"></i> Profile</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-cog"></i> Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Complaints Header -->
                <div class="complaints-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2><i class="fas fa-exclamation-triangle"></i> Complaints Dashboard</h2>
                            <p class="mb-0">Monitor and manage all human rights complaints efficiently</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                <button class="btn btn-light" onclick="refreshComplaints()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button class="btn btn-warning" onclick="showBulkActions()">
                                    <i class="fas fa-tasks"></i> Bulk Actions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="stats-cards">
                    <div class="stat-card pending">
                        <div class="stat-number" id="pendingCount">0</div>
                        <div class="stat-label">Pending Complaints</div>
                    </div>
                    <div class="stat-card in-progress">
                        <div class="stat-number" id="inProgressCount">0</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card resolved">
                        <div class="stat-number" id="resolvedCount">0</div>
                        <div class="stat-label">Resolved</div>
                    </div>
                    <div class="stat-card rejected">
                        <div class="stat-number" id="rejectedCount">0</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                </div>

                <!-- Filters Section -->
                <div class="filters-section">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Status Filter</label>
                            <select class="form-select" id="statusFilter" onchange="filterComplaints()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Priority Filter</label>
                            <select class="form-select" id="priorityFilter" onchange="filterComplaints()">
                                <option value="">All Priorities</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date Range</label>
                            <input type="date" class="form-control" id="dateFrom" onchange="filterComplaints()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" placeholder="Search complaints..." onkeyup="searchComplaints()">
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="bulk-actions" id="bulkActions">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <span id="selectedCount">0</span> complaints selected
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-info" onclick="bulkUpdateStatus('in_progress')">
                                Mark In Progress
                            </button>
                            <button class="btn btn-sm btn-success" onclick="bulkUpdateStatus('resolved')">
                                Mark Resolved
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="bulkUpdateStatus('rejected')">
                                Mark Rejected
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                                Clear Selection
                            </button>
                        </div>
                    </div>
                </div>

                <!-- View Toggle -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="text-muted">Total: <span id="totalComplaints">0</span> complaints</span>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary active" onclick="switchView('table')">
                            <i class="fas fa-table"></i> Table
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="switchView('cards')">
                            <i class="fas fa-th-large"></i> Cards
                        </button>
                    </div>
                </div>

                <!-- Complaints Table View -->
                <div class="complaints-table" id="tableView">
                    <div class="table-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">All Complaints</h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="sortComplaints('date')">
                                    <i class="fas fa-sort"></i> Sort by Date
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="sortComplaints('priority')">
                                    <i class="fas fa-sort"></i> Sort by Priority
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">
                                        <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th>ID</th>
                                    <th>Complainant</th>
                                    <th>Subject</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="complaintsTableBody">
                                <!-- Complaints will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Complaints Cards View -->
                <div id="cardsView" style="display: none;">
                    <div id="complaintsCardsContainer">
                        <!-- Complaint cards will be loaded here -->
                    </div>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div>
                        <select class="form-select form-select-sm" id="itemsPerPage" onchange="changeItemsPerPage()" style="width: auto;">
                            <option value="10">10 per page</option>
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>
                    <nav>
                        <ul class="pagination mb-0" id="pagination">
                            <!-- Pagination will be generated here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Complaint Details Modal -->
    <div class="modal fade" id="complaintModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Complaint Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="complaintModalBody">
                    <!-- Complaint details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printComplaint()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Response Modal -->
    <div class="modal fade" id="responseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Response</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="responseForm">
                        <input type="hidden" id="responseComplaintId">
                        <div class="mb-3">
                            <label class="form-label">Response Type</label>
                            <select class="form-select" name="response_type" required>
                                <option value="">Select Type</option>
                                <option value="acknowledgment">Acknowledgment</option>
                                <option value="investigation">Investigation Update</option>
                                <option value="resolution">Resolution</option>
                                <option value="rejection">Rejection</option>
                                <option value="request_info">Request for Information</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Response Message</label>
                            <textarea class="form-control" name="message" rows="5" required 
                                      placeholder="Enter your response message..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Update Status</label>
                            <select class="form-select" name="new_status">
                                <option value="">Keep Current Status</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Attachments</label>
                            <input type="file" class="form-control" name="attachments[]" multiple 
                                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            <small class="form-text text-muted">Upload supporting documents (max 10MB each)</small>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="notify_complainant" id="notifyComplainant" checked>
                            <label class="form-check-label" for="notifyComplainant">
                                Notify complainant via email
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitResponse()">
                        <i class="fas fa-paper-plane"></i> Send Response
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="fab" onclick="scrollToTop()" title="Scroll to Top">
            <i class="fas fa-arrow-up"></i>
        </button>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/admin.js"></script>
    <script>
        class ComplaintsManager {
            constructor() {
                this.complaints = [];
                this.filteredComplaints = [];
                this.selectedComplaints = [];
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.currentView = 'table';
                this.sortBy = 'date';
                this.sortOrder = 'desc';
                this.init();
            }

            async init() {
                await this.loadComplaints();
                this.updateStats();
                this.renderComplaints();
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Auto-refresh every 30 seconds
                setInterval(() => {
                    this.loadComplaints(false);
                }, 30000);
            }

            async loadComplaints(showLoading = true) {
                if (showLoading) {
                    this.showLoading();
                }

                try {
                    const response = await fetch(window.BHRC_CONFIG ? window.BHRC_CONFIG.API.BASE_URL + ''.replace('/api', '') : 'https://bhrcdata.online/backend/api'.replace('/api', '')));
                    const result = await response.json();
                    
                    if (result.success) {
                        this.complaints = result.data;
                        this.filteredComplaints = [...this.complaints];
                        this.updateStats();
                        this.renderComplaints();
                    } else {
                        this.showToast('Error loading complaints: ' + result.message, 'error');
                    }
                } catch (error) {
                    this.showToast('Error loading complaints: ' + error.message, 'error');
                    // Load sample data for demo
                    this.loadSampleData();
                }

                if (showLoading) {
                    this.hideLoading();
                }
            }

            loadSampleData() {
                this.complaints = [
                    {
                        id: 'BHRC001',
                        complainant_name: 'Rajesh Kumar',
                        complainant_email: 'rajesh@email.com',
                        complainant_phone: '+91 9876543210',
                        subject: 'Police Brutality in Patna',
                        description: 'I was subjected to unnecessary force by police officers during a peaceful protest. This is a violation of my fundamental rights.',
                        status: 'pending',
                        priority: 'high',
                        category: 'police_brutality',
                        location: 'Patna, Bharatiya',
                        incident_date: '2024-01-15',
                        created_at: '2024-01-16T10:30:00Z',
                        updated_at: '2024-01-16T10:30:00Z',
                        attachments: ['evidence1.jpg', 'witness_statement.pdf'],
                        responses: []
                    },
                    {
                        id: 'BHRC002',
                        complainant_name: 'Priya Singh',
                        complainant_email: 'priya@email.com',
                        complainant_phone: '+91 9876543211',
                        subject: 'Discrimination in Employment',
                        description: 'I was denied employment based on my caste. This is clear discrimination and violation of equal opportunity.',
                        status: 'in_progress',
                        priority: 'medium',
                        category: 'discrimination',
                        location: 'Gaya, Bharatiya',
                        incident_date: '2024-01-10',
                        created_at: '2024-01-12T14:20:00Z',
                        updated_at: '2024-01-18T09:15:00Z',
                        attachments: ['job_rejection.pdf'],
                        responses: [
                            {
                                date: '2024-01-18T09:15:00Z',
                                type: 'acknowledgment',
                                message: 'Your complaint has been received and is under investigation.',
                                officer: 'Admin Officer'
                            }
                        ]
                    },
                    {
                        id: 'BHRC003',
                        complainant_name: 'Mohammad Ali',
                        complainant_email: 'ali@email.com',
                        complainant_phone: '+91 9876543212',
                        subject: 'Right to Education Violation',
                        description: 'My child was denied admission to a government school without proper justification.',
                        status: 'resolved',
                        priority: 'medium',
                        category: 'education',
                        location: 'Muzaffarpur, Bharatiya',
                        incident_date: '2024-01-05',
                        created_at: '2024-01-06T11:45:00Z',
                        updated_at: '2024-01-20T16:30:00Z',
                        attachments: ['admission_denial.pdf', 'child_documents.pdf'],
                        responses: [
                            {
                                date: '2024-01-20T16:30:00Z',
                                type: 'resolution',
                                message: 'The matter has been resolved. The child has been granted admission.',
                                officer: 'Education Officer'
                            }
                        ]
                    }
                ];
                this.filteredComplaints = [...this.complaints];
                this.updateStats();
                this.renderComplaints();
            }

            updateStats() {
                const stats = {
                    pending: this.complaints.filter(c => c.status === 'pending').length,
                    in_progress: this.complaints.filter(c => c.status === 'in_progress').length,
                    resolved: this.complaints.filter(c => c.status === 'resolved').length,
                    rejected: this.complaints.filter(c => c.status === 'rejected').length
                };

                document.getElementById('pendingCount').textContent = stats.pending;
                document.getElementById('inProgressCount').textContent = stats.in_progress;
                document.getElementById('resolvedCount').textContent = stats.resolved;
                document.getElementById('rejectedCount').textContent = stats.rejected;
                document.getElementById('totalComplaints').textContent = this.filteredComplaints.length;
            }

            renderComplaints() {
                if (this.currentView === 'table') {
                    this.renderTableView();
                } else {
                    this.renderCardsView();
                }
                this.renderPagination();
            }

            renderTableView() {
                const tbody = document.getElementById('complaintsTableBody');
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const pageComplaints = this.filteredComplaints.slice(startIndex, endIndex);

                tbody.innerHTML = pageComplaints.map(complaint => `
                    <tr class="complaint-row" onclick="viewComplaint('${complaint.id}')">
                        <td>
                            <input type="checkbox" class="form-check-input complaint-checkbox" 
                                   value="${complaint.id}" onclick="event.stopPropagation(); toggleComplaintSelection('${complaint.id}')">
                        </td>
                        <td><strong>${complaint.id}</strong></td>
                        <td>
                            <div>${complaint.complainant_name}</div>
                            <small class="text-muted">${complaint.complainant_email}</small>
                        </td>
                        <td>
                            <div class="fw-bold">${complaint.subject}</div>
                            <small class="text-muted">${complaint.description.substring(0, 50)}...</small>
                        </td>
                        <td>
                            <span class="status-badge status-${complaint.status}">
                                ${complaint.status.replace('_', ' ')}
                            </span>
                        </td>
                        <td>
                            <i class="fas fa-circle priority-${complaint.priority}"></i>
                            ${complaint.priority}
                        </td>
                        <td>${this.formatDate(complaint.created_at)}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="event.stopPropagation(); viewComplaint('${complaint.id}')" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="event.stopPropagation(); respondToComplaint('${complaint.id}')" title="Respond">
                                    <i class="fas fa-reply"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="event.stopPropagation(); updateStatus('${complaint.id}')" title="Update Status">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            renderCardsView() {
                const container = document.getElementById('complaintsCardsContainer');
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const pageComplaints = this.filteredComplaints.slice(startIndex, endIndex);

                container.innerHTML = pageComplaints.map(complaint => `
                    <div class="complaint-card ${complaint.status}" onclick="viewComplaint('${complaint.id}')">
                        <div class="complaint-header">
                            <div>
                                <h6 class="mb-1">${complaint.id}</h6>
                                <h5 class="mb-0">${complaint.subject}</h5>
                            </div>
                            <div class="text-end">
                                <span class="status-badge status-${complaint.status}">
                                    ${complaint.status.replace('_', ' ')}
                                </span>
                                <div class="mt-1">
                                    <i class="fas fa-circle priority-${complaint.priority}"></i>
                                    <small>${complaint.priority}</small>
                                </div>
                            </div>
                        </div>
                        <div class="complaint-meta">
                            <span><i class="fas fa-user"></i> ${complaint.complainant_name}</span>
                            <span><i class="fas fa-map-marker-alt"></i> ${complaint.location}</span>
                            <span><i class="fas fa-calendar"></i> ${this.formatDate(complaint.created_at)}</span>
                        </div>
                        <div class="complaint-description">
                            ${complaint.description.substring(0, 150)}...
                        </div>
                        <div class="complaint-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewComplaint('${complaint.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); respondToComplaint('${complaint.id}')">
                                <i class="fas fa-reply"></i> Respond
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); updateStatus('${complaint.id}')">
                                <i class="fas fa-edit"></i> Update
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderPagination() {
                const totalPages = Math.ceil(this.filteredComplaints.length / this.itemsPerPage);
                const pagination = document.getElementById('pagination');
                
                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                let paginationHTML = '';
                
                // Previous button
                paginationHTML += `
                    <li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${this.currentPage - 1})">Previous</a>
                    </li>
                `;
                
                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                        paginationHTML += `
                            <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                            </li>
                        `;
                    } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
                        paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                    }
                }
                
                // Next button
                paginationHTML += `
                    <li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${this.currentPage + 1})">Next</a>
                    </li>
                `;
                
                pagination.innerHTML = paginationHTML;
            }

            async viewComplaint(complaintId) {
                const complaint = this.complaints.find(c => c.id === complaintId);
                if (!complaint) return;

                const modalBody = document.getElementById('complaintModalBody');
                modalBody.innerHTML = `
                    <div class="complaint-details">
                        <!-- Basic Information -->
                        <div class="detail-section">
                            <h5 class="section-title">
                                <i class="fas fa-info-circle"></i> Basic Information
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Complaint ID:</strong> ${complaint.id}</p>
                                    <p><strong>Subject:</strong> ${complaint.subject}</p>
                                    <p><strong>Category:</strong> ${complaint.category.replace('_', ' ')}</p>
                                    <p><strong>Priority:</strong> 
                                        <i class="fas fa-circle priority-${complaint.priority}"></i>
                                        ${complaint.priority}
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Status:</strong> 
                                        <span class="status-badge status-${complaint.status}">
                                            ${complaint.status.replace('_', ' ')}
                                        </span>
                                    </p>
                                    <p><strong>Location:</strong> ${complaint.location}</p>
                                    <p><strong>Incident Date:</strong> ${this.formatDate(complaint.incident_date)}</p>
                                    <p><strong>Filed Date:</strong> ${this.formatDate(complaint.created_at)}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Complainant Information -->
                        <div class="detail-section">
                            <h5 class="section-title">
                                <i class="fas fa-user"></i> Complainant Information
                            </h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <p><strong>Name:</strong> ${complaint.complainant_name}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Email:</strong> ${complaint.complainant_email}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Phone:</strong> ${complaint.complainant_phone}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Complaint Description -->
                        <div class="detail-section">
                            <h5 class="section-title">
                                <i class="fas fa-file-alt"></i> Complaint Description
                            </h5>
                            <p>${complaint.description}</p>
                        </div>

                        <!-- Attachments -->
                        ${complaint.attachments && complaint.attachments.length > 0 ? `
                        <div class="detail-section">
                            <h5 class="section-title">
                                <i class="fas fa-paperclip"></i> Attachments
                            </h5>
                            <div class="complaint-attachments">
                                ${complaint.attachments.map(attachment => `
                                    <div class="attachment-item">
                                        <div class="attachment-icon">
                                            <i class="fas fa-file-${this.getFileIcon(attachment)}"></i>
                                        </div>
                                        <div class="attachment-name">${attachment}</div>
                                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadAttachment('${attachment}')">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Response Timeline -->
                        <div class="detail-section">
                            <h5 class="section-title">
                                <i class="fas fa-history"></i> Response Timeline
                            </h5>
                            <div class="timeline">
                                <div class="timeline-item">
                                    <div class="timeline-date">${this.formatDateTime(complaint.created_at)}</div>
                                    <div class="timeline-content">
                                        <strong>Complaint Filed</strong><br>
                                        Complaint submitted by ${complaint.complainant_name}
                                    </div>
                                </div>
                                ${complaint.responses ? complaint.responses.map(response => `
                                    <div class="timeline-item">
                                        <div class="timeline-date">${this.formatDateTime(response.date)}</div>
                                        <div class="timeline-content">
                                            <strong>${response.type.replace('_', ' ')}</strong> by ${response.officer}<br>
                                            ${response.message}
                                        </div>
                                    </div>
                                `).join('') : ''}
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="detail-section">
                            <h5 class="section-title">
                                <i class="fas fa-tools"></i> Quick Actions
                            </h5>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="respondToComplaint('${complaint.id}')">
                                    <i class="fas fa-reply"></i> Add Response
                                </button>
                                <button class="btn btn-info" onclick="updateComplaintStatus('${complaint.id}', 'in_progress')">
                                    <i class="fas fa-play"></i> Mark In Progress
                                </button>
                                <button class="btn btn-warning" onclick="updateComplaintStatus('${complaint.id}', 'resolved')">
                                    <i class="fas fa-check"></i> Mark Resolved
                                </button>
                                <button class="btn btn-danger" onclick="updateComplaintStatus('${complaint.id}', 'rejected')">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportComplaint('${complaint.id}')">
                                    <i class="fas fa-download"></i> Export PDF
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                const modal = new bootstrap.Modal(document.getElementById('complaintModal'));
                modal.show();
            }

            // Utility methods
            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString('en-IN');
            }

            formatDateTime(dateString) {
                return new Date(dateString).toLocaleString('en-IN');
            }

            getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                switch (ext) {
                    case 'pdf': return 'pdf';
                    case 'doc':
                    case 'docx': return 'word';
                    case 'jpg':
                    case 'jpeg':
                    case 'png': return 'image';
                    default: return 'alt';
                }
            }

            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                const toastHTML = `
                    <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0" role="alert">
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                const toast = new bootstrap.Toast(document.getElementById(toastId));
                toast.show();
                
                document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
                    this.remove();
                });
            }

            showLoading() {
                // Implementation for loading indicator
            }

            hideLoading() {
                // Implementation for hiding loading indicator
            }
        }

        // Global functions
        let complaintsManager;

        function filterComplaints() {
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            
            complaintsManager.filteredComplaints = complaintsManager.complaints.filter(complaint => {
                let matches = true;
                
                if (statusFilter && complaint.status !== statusFilter) {
                    matches = false;
                }
                
                if (priorityFilter && complaint.priority !== priorityFilter) {
                    matches = false;
                }
                
                if (dateFrom && new Date(complaint.created_at) < new Date(dateFrom)) {
                    matches = false;
                }
                
                return matches;
            });
            
            complaintsManager.currentPage = 1;
            complaintsManager.updateStats();
            complaintsManager.renderComplaints();
        }

        function searchComplaints() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            complaintsManager.filteredComplaints = complaintsManager.complaints.filter(complaint => {
                return complaint.subject.toLowerCase().includes(searchTerm) ||
                       complaint.complainant_name.toLowerCase().includes(searchTerm) ||
                       complaint.description.toLowerCase().includes(searchTerm) ||
                       complaint.id.toLowerCase().includes(searchTerm);
            });
            
            complaintsManager.currentPage = 1;
            complaintsManager.updateStats();
            complaintsManager.renderComplaints();
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('searchInput').value = '';
            
            complaintsManager.filteredComplaints = [...complaintsManager.complaints];
            complaintsManager.currentPage = 1;
            complaintsManager.updateStats();
            complaintsManager.renderComplaints();
        }

        function switchView(view) {
            complaintsManager.currentView = view;
            
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (view === 'table') {
                document.getElementById('tableView').style.display = 'block';
                document.getElementById('cardsView').style.display = 'none';
            } else {
                document.getElementById('tableView').style.display = 'none';
                document.getElementById('cardsView').style.display = 'block';
            }
            
            complaintsManager.renderComplaints();
        }

        function changePage(page) {
            const totalPages = Math.ceil(complaintsManager.filteredComplaints.length / complaintsManager.itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                complaintsManager.currentPage = page;
                complaintsManager.renderComplaints();
            }
        }

        function changeItemsPerPage() {
            complaintsManager.itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            complaintsManager.currentPage = 1;
            complaintsManager.renderComplaints();
        }

        function viewComplaint(complaintId) {
            complaintsManager.viewComplaint(complaintId);
        }

        function respondToComplaint(complaintId) {
            document.getElementById('responseComplaintId').value = complaintId;
            const modal = new bootstrap.Modal(document.getElementById('responseModal'));
            modal.show();
        }

        async function submitResponse() {
            const form = document.getElementById('responseForm');
            const formData = new FormData(form);
            const complaintId = document.getElementById('responseComplaintId').value;
            
            try {
                const response = await fetch(`/api/complaints/${complaintId}/responses`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    complaintsManager.showToast('Response added successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('responseModal')).hide();
                    complaintsManager.loadComplaints();
                } else {
                    complaintsManager.showToast('Error adding response: ' + result.message, 'error');
                }
            } catch (error) {
                complaintsManager.showToast('Error adding response: ' + error.message, 'error');
            }
        }

        async function updateComplaintStatus(complaintId, newStatus) {
            try {
                const response = await fetch(`/api/complaints/${complaintId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    complaintsManager.showToast('Status updated successfully!', 'success');
                    complaintsManager.loadComplaints();
                } else {
                    complaintsManager.showToast('Error updating status: ' + result.message, 'error');
                }
            } catch (error) {
                complaintsManager.showToast('Error updating status: ' + error.message, 'error');
            }
        }

        function refreshComplaints() {
            complaintsManager.loadComplaints();
        }

        function exportComplaints() {
            // Implementation for exporting complaints
            complaintsManager.showToast('Export functionality will be implemented', 'info');
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('authToken');
                window.location.href = '../login.html';
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            complaintsManager = new ComplaintsManager();
        });
    </script>
</body>
</html>



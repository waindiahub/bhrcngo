<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Applications - BHRC Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../assets/css/common.css" rel="stylesheet">
    <link href="../assets/css/admin.css" rel="stylesheet">
    <style>
        .application-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 4px solid #dee2e6;
        }
        .application-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .application-card.pending {
            border-left-color: #ffc107;
        }
        .application-card.approved {
            border-left-color: #28a745;
        }
        .application-card.rejected {
            border-left-color: #dc3545;
        }
        .application-card.under-review {
            border-left-color: #17a2b8;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .priority-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .priority-high { background-color: #dc3545; }
        .priority-medium { background-color: #ffc107; }
        .priority-low { background-color: #28a745; }
        .application-timeline {
            position: relative;
            padding-left: 30px;
        }
        .application-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 5px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #007bff;
        }
        .document-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            cursor: pointer;
        }
        .bulk-actions {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        .bulk-actions.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-shield-alt"></i> BHRC Admin</h4>
        </div>
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="members.html" class="nav-link">
                <i class="fas fa-users"></i> Members
            </a>
            <a href="applications.html" class="nav-link active">
                <i class="fas fa-file-alt"></i> Applications
            </a>
            <a href="activities.html" class="nav-link">
                <i class="fas fa-calendar-alt"></i> Activities
            </a>
            <a href="events.html" class="nav-link">
                <i class="fas fa-calendar-check"></i> Events
            </a>
            <a href="gallery.html" class="nav-link">
                <i class="fas fa-images"></i> Gallery
            </a>
            <a href="donations.html" class="nav-link">
                <i class="fas fa-heart"></i> Donations
            </a>
            <a href="complaints.html" class="nav-link">
                <i class="fas fa-exclamation-triangle"></i> Complaints
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="main-header">
            <div class="header-left">
                <button class="btn btn-link sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Applications</h1>
            </div>
            <div class="header-right">
                <button class="btn btn-outline-primary me-2" onclick="exportApplications()">
                    <i class="fas fa-download"></i> Export
                </button>
                <div class="dropdown">
                    <button class="btn btn-link dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle"></i> Admin
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-user"></i> Profile</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-cog"></i> Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                    </ul>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="content-wrapper">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Pending</h6>
                                    <h3 id="pendingCount">0</h3>
                                </div>
                                <i class="fas fa-clock fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Under Review</h6>
                                    <h3 id="reviewCount">0</h3>
                                </div>
                                <i class="fas fa-search fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Approved</h6>
                                    <h3 id="approvedCount">0</h3>
                                </div>
                                <i class="fas fa-check fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Rejected</h6>
                                    <h3 id="rejectedCount">0</h3>
                                </div>
                                <i class="fas fa-times fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search applications...">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="under-review">Under Review</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="typeFilter">
                                <option value="">All Types</option>
                                <option value="membership">Membership</option>
                                <option value="volunteer">Volunteer</option>
                                <option value="partnership">Partnership</option>
                                <option value="donation">Donation Request</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="priorityFilter">
                                <option value="">All Priority</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="sortBy">
                                <option value="created_desc">Newest First</option>
                                <option value="created_asc">Oldest First</option>
                                <option value="priority_desc">High Priority First</option>
                                <option value="name_asc">Name A-Z</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                                <label class="form-check-label" for="selectAll">
                                    All
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="bulk-actions" id="bulkActions">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="selectedCount">0 applications selected</span>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="bulkApprove()">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="bulkReject()">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        <button class="btn btn-info btn-sm" onclick="bulkReview()">
                            <i class="fas fa-search"></i> Mark for Review
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="bulkExport()">
                            <i class="fas fa-download"></i> Export Selected
                        </button>
                    </div>
                </div>
            </div>

            <!-- Applications List -->
            <div id="applicationsContainer">
                <!-- Applications will be loaded here -->
            </div>

            <!-- Pagination -->
            <nav aria-label="Applications pagination" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Pagination will be generated here -->
                </ul>
            </nav>
        </div>
    </div>

    <!-- Application Details Modal -->
    <div class="modal fade" id="applicationModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="applicationModalTitle">Application Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="applicationDetails">
                        <!-- Application details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-info" id="reviewBtn" onclick="reviewApplication()">
                        <i class="fas fa-search"></i> Review
                    </button>
                    <button type="button" class="btn btn-danger" id="rejectBtn" onclick="rejectApplication()">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    <button type="button" class="btn btn-success" id="approveBtn" onclick="approveApplication()">
                        <i class="fas fa-check"></i> Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Review/Reject Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionModalTitle">Action Required</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" id="actionLabel">Comments:</label>
                        <textarea class="form-control" id="actionComments" rows="4" placeholder="Enter your comments..."></textarea>
                    </div>
                    <div class="mb-3" id="prioritySection" style="display: none;">
                        <label class="form-label">Priority:</label>
                        <select class="form-select" id="actionPriority">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmActionBtn" onclick="confirmAction()">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class ApplicationsManager {
            constructor() {
                this.applications = [];
                this.filteredApplications = [];
                this.selectedApplications = new Set();
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.currentAction = null;
                this.currentApplicationId = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadApplications();
                this.updateStats();
            }

            setupEventListeners() {
                // Search and filters
                document.getElementById('searchInput').addEventListener('input', () => this.filterApplications());
                document.getElementById('statusFilter').addEventListener('change', () => this.filterApplications());
                document.getElementById('typeFilter').addEventListener('change', () => this.filterApplications());
                document.getElementById('priorityFilter').addEventListener('change', () => this.filterApplications());
                document.getElementById('sortBy').addEventListener('change', () => this.filterApplications());

                // Select all checkbox
                document.getElementById('selectAll').addEventListener('change', (e) => {
                    this.toggleSelectAll(e.target.checked);
                });
            }

            async loadApplications() {
                try {
                    // Simulate API call
                    const response = await fetch(window.BHRC_CONFIG ? window.BHRC_CONFIG.API.BASE_URL + ''.replace('/api', '') : 'https://bhrcdata.online/backend/api'.replace('/api', '')));
                    // For demo, use mock data
                    this.applications = this.getMockApplications();
                    this.filteredApplications = [...this.applications];
                    this.renderApplications();
                    this.updateStats();
                } catch (error) {
                    console.error('Error loading applications:', error);
                    // Use mock data for demo
                    this.applications = this.getMockApplications();
                    this.filteredApplications = [...this.applications];
                    this.renderApplications();
                    this.updateStats();
                }
            }

            getMockApplications() {
                return [
                    {
                        id: 1,
                        applicantName: 'John Doe',
                        email: 'john.doe@email.com',
                        phone: '+91 9876543210',
                        type: 'membership',
                        status: 'pending',
                        priority: 'high',
                        submittedDate: '2024-01-15',
                        lastUpdated: '2024-01-15',
                        documents: ['id_proof.pdf', 'address_proof.pdf'],
                        comments: [],
                        details: {
                            membershipType: 'Regular',
                            experience: '5 years in social work',
                            motivation: 'Want to contribute to human rights causes',
                            references: ['Dr. Smith', 'Ms. Johnson']
                        }
                    },
                    {
                        id: 2,
                        applicantName: 'Jane Smith',
                        email: 'jane.smith@email.com',
                        phone: '+91 9876543211',
                        type: 'volunteer',
                        status: 'under-review',
                        priority: 'medium',
                        submittedDate: '2024-01-12',
                        lastUpdated: '2024-01-14',
                        documents: ['resume.pdf', 'cover_letter.pdf'],
                        comments: [
                            { date: '2024-01-14', author: 'Admin', text: 'Good application, needs verification' }
                        ],
                        details: {
                            availability: 'Weekends',
                            skills: ['Communication', 'Event Management'],
                            previousExperience: 'Volunteered at local NGO for 2 years'
                        }
                    },
                    {
                        id: 3,
                        applicantName: 'Robert Johnson',
                        email: 'robert.j@email.com',
                        phone: '+91 9876543212',
                        type: 'partnership',
                        status: 'approved',
                        priority: 'high',
                        submittedDate: '2024-01-10',
                        lastUpdated: '2024-01-13',
                        documents: ['organization_profile.pdf', 'mou_draft.pdf'],
                        comments: [
                            { date: '2024-01-13', author: 'Admin', text: 'Excellent proposal, approved for partnership' }
                        ],
                        details: {
                            organizationName: 'Community Welfare Society',
                            partnershipType: 'Strategic Alliance',
                            proposedActivities: 'Joint awareness campaigns'
                        }
                    },
                    {
                        id: 4,
                        applicantName: 'Sarah Wilson',
                        email: 'sarah.w@email.com',
                        phone: '+91 9876543213',
                        type: 'donation',
                        status: 'rejected',
                        priority: 'low',
                        submittedDate: '2024-01-08',
                        lastUpdated: '2024-01-12',
                        documents: ['donation_proposal.pdf'],
                        comments: [
                            { date: '2024-01-12', author: 'Admin', text: 'Does not align with our current priorities' }
                        ],
                        details: {
                            donationType: 'Equipment',
                            proposedDonation: 'Old computers',
                            estimatedValue: '$5000'
                        }
                    },
                    {
                        id: 5,
                        applicantName: 'Michael Brown',
                        email: 'michael.b@email.com',
                        phone: '+91 9876543214',
                        type: 'membership',
                        status: 'pending',
                        priority: 'medium',
                        submittedDate: '2024-01-14',
                        lastUpdated: '2024-01-14',
                        documents: ['application_form.pdf', 'photo.jpg'],
                        comments: [],
                        details: {
                            membershipType: 'Student',
                            currentStudy: 'Law Student at Delhi University',
                            interests: ['Legal Aid', 'Human Rights Research']
                        }
                    }
                ];
            }

            filterApplications() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                const priorityFilter = document.getElementById('priorityFilter').value;
                const sortBy = document.getElementById('sortBy').value;

                this.filteredApplications = this.applications.filter(app => {
                    const matchesSearch = app.applicantName.toLowerCase().includes(searchTerm) ||
                                        app.email.toLowerCase().includes(searchTerm) ||
                                        app.type.toLowerCase().includes(searchTerm);
                    const matchesStatus = !statusFilter || app.status === statusFilter;
                    const matchesType = !typeFilter || app.type === typeFilter;
                    const matchesPriority = !priorityFilter || app.priority === priorityFilter;

                    return matchesSearch && matchesStatus && matchesType && matchesPriority;
                });

                // Sort applications
                this.filteredApplications.sort((a, b) => {
                    switch (sortBy) {
                        case 'created_desc':
                            return new Date(b.submittedDate) - new Date(a.submittedDate);
                        case 'created_asc':
                            return new Date(a.submittedDate) - new Date(b.submittedDate);
                        case 'priority_desc':
                            const priorityOrder = { high: 3, medium: 2, low: 1 };
                            return priorityOrder[b.priority] - priorityOrder[a.priority];
                        case 'name_asc':
                            return a.applicantName.localeCompare(b.applicantName);
                        default:
                            return 0;
                    }
                });

                this.currentPage = 1;
                this.selectedApplications.clear();
                this.updateBulkActions();
                this.renderApplications();
            }

            renderApplications() {
                const container = document.getElementById('applicationsContainer');
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const applicationsToShow = this.filteredApplications.slice(startIndex, endIndex);

                if (applicationsToShow.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No applications found</h5>
                            <p class="text-muted">Try adjusting your search criteria</p>
                        </div>
                    `;
                    return;
                }

                const html = applicationsToShow.map(app => {
                    const statusClass = app.status.replace('-', '');
                    const statusIcon = {
                        'pending': 'clock',
                        'under-review': 'search',
                        'approved': 'check',
                        'rejected': 'times'
                    }[app.status];

                    const typeIcon = {
                        'membership': 'user-plus',
                        'volunteer': 'hands-helping',
                        'partnership': 'handshake',
                        'donation': 'heart'
                    }[app.type];

                    return `
                        <div class="card application-card ${statusClass} mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-1">
                                        <div class="form-check">
                                            <input class="form-check-input application-checkbox" type="checkbox" 
                                                   value="${app.id}" onchange="applicationsManager.toggleSelection(${app.id})">
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="fas fa-${typeIcon} me-2"></i>
                                                ${app.applicantName}
                                                <span class="priority-indicator priority-${app.priority}" title="${app.priority} priority"></span>
                                            </h6>
                                            <span class="badge status-badge bg-${statusClass === 'underreview' ? 'info' : statusClass === 'pending' ? 'warning' : statusClass === 'approved' ? 'success' : 'danger'}">
                                                <i class="fas fa-${statusIcon}"></i> ${app.status.replace('-', ' ')}
                                            </span>
                                        </div>
                                        <p class="text-muted mb-2">
                                            <i class="fas fa-envelope me-1"></i> ${app.email} |
                                            <i class="fas fa-phone me-1"></i> ${app.phone}
                                        </p>
                                        <p class="mb-2">
                                            <span class="badge bg-light text-dark me-2">
                                                <i class="fas fa-tag"></i> ${app.type}
                                            </span>
                                            <small class="text-muted">
                                                Submitted: ${new Date(app.submittedDate).toLocaleDateString()}
                                            </small>
                                        </p>
                                        <div class="d-flex align-items-center">
                                            <small class="text-muted me-3">
                                                <i class="fas fa-paperclip"></i> ${app.documents.length} documents
                                            </small>
                                            <small class="text-muted">
                                                <i class="fas fa-comments"></i> ${app.comments.length} comments
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <div class="btn-group-vertical btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="viewApplication(${app.id})">
                                                <i class="fas fa-eye"></i> View Details
                                            </button>
                                            ${app.status === 'pending' ? `
                                                <div class="btn-group btn-group-sm mt-1">
                                                    <button class="btn btn-success" onclick="quickApprove(${app.id})">
                                                        <i class="fas fa-check"></i> Approve
                                                    </button>
                                                    <button class="btn btn-danger" onclick="quickReject(${app.id})">
                                                        <i class="fas fa-times"></i> Reject
                                                    </button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
                this.renderPagination();
            }

            renderPagination() {
                const totalPages = Math.ceil(this.filteredApplications.length / this.itemsPerPage);
                const pagination = document.getElementById('pagination');

                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                let html = '';

                // Previous button
                html += `
                    <li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="applicationsManager.changePage(${this.currentPage - 1})">Previous</a>
                    </li>
                `;

                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                        html += `
                            <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" onclick="applicationsManager.changePage(${i})">${i}</a>
                            </li>
                        `;
                    } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
                        html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                    }
                }

                // Next button
                html += `
                    <li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="applicationsManager.changePage(${this.currentPage + 1})">Next</a>
                    </li>
                `;

                pagination.innerHTML = html;
            }

            changePage(page) {
                const totalPages = Math.ceil(this.filteredApplications.length / this.itemsPerPage);
                if (page >= 1 && page <= totalPages) {
                    this.currentPage = page;
                    this.renderApplications();
                }
            }

            toggleSelection(applicationId) {
                if (this.selectedApplications.has(applicationId)) {
                    this.selectedApplications.delete(applicationId);
                } else {
                    this.selectedApplications.add(applicationId);
                }
                this.updateBulkActions();
            }

            toggleSelectAll(selectAll) {
                const checkboxes = document.querySelectorAll('.application-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAll;
                    const appId = parseInt(checkbox.value);
                    if (selectAll) {
                        this.selectedApplications.add(appId);
                    } else {
                        this.selectedApplications.delete(appId);
                    }
                });
                this.updateBulkActions();
            }

            updateBulkActions() {
                const bulkActions = document.getElementById('bulkActions');
                const selectedCount = document.getElementById('selectedCount');
                
                if (this.selectedApplications.size > 0) {
                    bulkActions.classList.add('show');
                    selectedCount.textContent = `${this.selectedApplications.size} applications selected`;
                } else {
                    bulkActions.classList.remove('show');
                }
            }

            updateStats() {
                const stats = this.applications.reduce((acc, app) => {
                    acc[app.status] = (acc[app.status] || 0) + 1;
                    return acc;
                }, {});

                document.getElementById('pendingCount').textContent = stats.pending || 0;
                document.getElementById('reviewCount').textContent = stats['under-review'] || 0;
                document.getElementById('approvedCount').textContent = stats.approved || 0;
                document.getElementById('rejectedCount').textContent = stats.rejected || 0;
            }

            viewApplication(applicationId) {
                const application = this.applications.find(app => app.id === applicationId);
                if (!application) return;

                this.currentApplicationId = applicationId;
                
                const modal = document.getElementById('applicationModal');
                const title = document.getElementById('applicationModalTitle');
                const details = document.getElementById('applicationDetails');

                title.textContent = `${application.applicantName} - ${application.type} Application`;

                const typeDetails = this.renderTypeSpecificDetails(application);
                const timeline = this.renderTimeline(application);

                details.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6><i class="fas fa-user"></i> Applicant Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Name:</strong> ${application.applicantName}</p>
                                            <p><strong>Email:</strong> ${application.email}</p>
                                            <p><strong>Phone:</strong> ${application.phone}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Type:</strong> <span class="badge bg-primary">${application.type}</span></p>
                                            <p><strong>Status:</strong> <span class="badge bg-${application.status === 'pending' ? 'warning' : application.status === 'approved' ? 'success' : application.status === 'rejected' ? 'danger' : 'info'}">${application.status}</span></p>
                                            <p><strong>Priority:</strong> <span class="priority-indicator priority-${application.priority}"></span>${application.priority}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            ${typeDetails}

                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6><i class="fas fa-paperclip"></i> Documents</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        ${application.documents.map(doc => `
                                            <div class="col-md-4 mb-2">
                                                <div class="border rounded p-2 text-center">
                                                    <i class="fas fa-file-pdf fa-2x text-danger mb-2"></i>
                                                    <p class="small mb-0">${doc}</p>
                                                    <button class="btn btn-sm btn-outline-primary mt-1" onclick="downloadDocument('${doc}')">
                                                        <i class="fas fa-download"></i> Download
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-history"></i> Timeline</h6>
                                </div>
                                <div class="card-body">
                                    ${timeline}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Update modal buttons based on status
                const reviewBtn = document.getElementById('reviewBtn');
                const rejectBtn = document.getElementById('rejectBtn');
                const approveBtn = document.getElementById('approveBtn');

                if (application.status === 'approved' || application.status === 'rejected') {
                    reviewBtn.style.display = 'none';
                    rejectBtn.style.display = 'none';
                    approveBtn.style.display = 'none';
                } else {
                    reviewBtn.style.display = 'inline-block';
                    rejectBtn.style.display = 'inline-block';
                    approveBtn.style.display = 'inline-block';
                }

                new bootstrap.Modal(modal).show();
            }

            renderTypeSpecificDetails(application) {
                const details = application.details;
                let html = '<div class="card mb-3"><div class="card-header"><h6><i class="fas fa-info-circle"></i> Application Details</h6></div><div class="card-body">';

                switch (application.type) {
                    case 'membership':
                        html += `
                            <p><strong>Membership Type:</strong> ${details.membershipType}</p>
                            <p><strong>Experience:</strong> ${details.experience}</p>
                            <p><strong>Motivation:</strong> ${details.motivation}</p>
                            <p><strong>References:</strong> ${details.references.join(', ')}</p>
                        `;
                        break;
                    case 'volunteer':
                        html += `
                            <p><strong>Availability:</strong> ${details.availability}</p>
                            <p><strong>Skills:</strong> ${details.skills.join(', ')}</p>
                            <p><strong>Previous Experience:</strong> ${details.previousExperience}</p>
                        `;
                        break;
                    case 'partnership':
                        html += `
                            <p><strong>Organization:</strong> ${details.organizationName}</p>
                            <p><strong>Partnership Type:</strong> ${details.partnershipType}</p>
                            <p><strong>Proposed Activities:</strong> ${details.proposedActivities}</p>
                        `;
                        break;
                    case 'donation':
                        html += `
                            <p><strong>Donation Type:</strong> ${details.donationType}</p>
                            <p><strong>Proposed Donation:</strong> ${details.proposedDonation}</p>
                            <p><strong>Estimated Value:</strong> ${details.estimatedValue}</p>
                        `;
                        break;
                }

                html += '</div></div>';
                return html;
            }

            renderTimeline(application) {
                let timeline = `
                    <div class="application-timeline">
                        <div class="timeline-item">
                            <small class="text-muted">${new Date(application.submittedDate).toLocaleDateString()}</small>
                            <p class="mb-0">Application submitted</p>
                        </div>
                `;

                application.comments.forEach(comment => {
                    timeline += `
                        <div class="timeline-item">
                            <small class="text-muted">${new Date(comment.date).toLocaleDateString()}</small>
                            <p class="mb-0"><strong>${comment.author}:</strong> ${comment.text}</p>
                        </div>
                    `;
                });

                timeline += '</div>';
                return timeline;
            }

            showActionModal(action, applicationId = null) {
                this.currentAction = action;
                this.currentApplicationId = applicationId;

                const modal = document.getElementById('actionModal');
                const title = document.getElementById('actionModalTitle');
                const label = document.getElementById('actionLabel');
                const prioritySection = document.getElementById('prioritySection');
                const confirmBtn = document.getElementById('confirmActionBtn');

                switch (action) {
                    case 'approve':
                        title.textContent = 'Approve Application';
                        label.textContent = 'Approval Comments:';
                        confirmBtn.textContent = 'Approve';
                        confirmBtn.className = 'btn btn-success';
                        prioritySection.style.display = 'none';
                        break;
                    case 'reject':
                        title.textContent = 'Reject Application';
                        label.textContent = 'Rejection Reason:';
                        confirmBtn.textContent = 'Reject';
                        confirmBtn.className = 'btn btn-danger';
                        prioritySection.style.display = 'none';
                        break;
                    case 'review':
                        title.textContent = 'Mark for Review';
                        label.textContent = 'Review Comments:';
                        confirmBtn.textContent = 'Mark for Review';
                        confirmBtn.className = 'btn btn-info';
                        prioritySection.style.display = 'block';
                        break;
                }

                new bootstrap.Modal(modal).show();
            }

            async confirmAction() {
                const comments = document.getElementById('actionComments').value;
                const priority = document.getElementById('actionPriority').value;

                if (!comments.trim()) {
                    this.showToast('Please enter comments', 'error');
                    return;
                }

                try {
                    if (this.currentApplicationId) {
                        // Single application action
                        await this.updateApplicationStatus(this.currentApplicationId, this.currentAction, comments, priority);
                    } else {
                        // Bulk action
                        for (const appId of this.selectedApplications) {
                            await this.updateApplicationStatus(appId, this.currentAction, comments, priority);
                        }
                        this.selectedApplications.clear();
                        this.updateBulkActions();
                    }

                    bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
                    bootstrap.Modal.getInstance(document.getElementById('applicationModal'))?.hide();
                    
                    document.getElementById('actionComments').value = '';
                    this.loadApplications();
                    this.showToast(`Application(s) ${this.currentAction}d successfully!`, 'success');

                } catch (error) {
                    this.showToast('Error updating application: ' + error.message, 'error');
                }
            }

            async updateApplicationStatus(applicationId, action, comments, priority = null) {
                const application = this.applications.find(app => app.id === applicationId);
                if (!application) return;

                // Update status
                switch (action) {
                    case 'approve':
                        application.status = 'approved';
                        break;
                    case 'reject':
                        application.status = 'rejected';
                        break;
                    case 'review':
                        application.status = 'under-review';
                        if (priority) application.priority = priority;
                        break;
                }

                // Add comment
                application.comments.push({
                    date: new Date().toISOString().split('T')[0],
                    author: 'Admin',
                    text: comments
                });

                application.lastUpdated = new Date().toISOString().split('T')[0];

                // Simulate API call
                await fetch(`/api/applications/${applicationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(application)
                });
            }

            // Quick action methods
            quickApprove(applicationId) {
                this.showActionModal('approve', applicationId);
            }

            quickReject(applicationId) {
                this.showActionModal('reject', applicationId);
            }

            reviewApplication() {
                this.showActionModal('review', this.currentApplicationId);
            }

            rejectApplication() {
                this.showActionModal('reject', this.currentApplicationId);
            }

            approveApplication() {
                this.showActionModal('approve', this.currentApplicationId);
            }

            // Bulk action methods
            bulkApprove() {
                if (this.selectedApplications.size === 0) return;
                this.showActionModal('approve');
            }

            bulkReject() {
                if (this.selectedApplications.size === 0) return;
                this.showActionModal('reject');
            }

            bulkReview() {
                if (this.selectedApplications.size === 0) return;
                this.showActionModal('review');
            }

            bulkExport() {
                if (this.selectedApplications.size === 0) return;
                const selectedApps = this.applications.filter(app => this.selectedApplications.has(app.id));
                this.exportData(selectedApps, 'selected_applications.csv');
            }

            exportApplications() {
                this.exportData(this.filteredApplications, 'applications.csv');
            }

            exportData(data, filename) {
                const headers = ['ID', 'Name', 'Email', 'Phone', 'Type', 'Status', 'Priority', 'Submitted Date', 'Last Updated'];
                const csvContent = [
                    headers.join(','),
                    ...data.map(app => [
                        app.id,
                        `"${app.applicantName}"`,
                        app.email,
                        app.phone,
                        app.type,
                        app.status,
                        app.priority,
                        app.submittedDate,
                        app.lastUpdated
                    ].join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                const toastHTML = `
                    <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header">
                            <i class="fas fa-${type === 'success' ? 'check-circle text-success' : 
                                              type === 'error' ? 'exclamation-circle text-danger' : 
                                              type === 'warning' ? 'exclamation-triangle text-warning' : 
                                              'info-circle text-info'}"></i>
                            <strong class="me-auto ms-2">Applications</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">${message}</div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                const toast = new bootstrap.Toast(document.getElementById(toastId));
                toast.show();
                
                // Remove toast element after it's hidden
                document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
                    this.remove();
                });
            }
        }

        // Global functions
        function viewApplication(applicationId) {
            applicationsManager.viewApplication(applicationId);
        }

        function quickApprove(applicationId) {
            applicationsManager.quickApprove(applicationId);
        }

        function quickReject(applicationId) {
            applicationsManager.quickReject(applicationId);
        }

        function reviewApplication() {
            applicationsManager.reviewApplication();
        }

        function rejectApplication() {
            applicationsManager.rejectApplication();
        }

        function approveApplication() {
            applicationsManager.approveApplication();
        }

        function confirmAction() {
            applicationsManager.confirmAction();
        }

        function bulkApprove() {
            applicationsManager.bulkApprove();
        }

        function bulkReject() {
            applicationsManager.bulkReject();
        }

        function bulkReview() {
            applicationsManager.bulkReview();
        }

        function bulkExport() {
            applicationsManager.bulkExport();
        }

        function exportApplications() {
            applicationsManager.exportApplications();
        }

        function downloadDocument(filename) {
            // Simulate document download
            const link = document.createElement('a');
            link.href = `/api/documents/${filename}`;
            link.download = filename;
            link.click();
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '../../../index.html';
            }
        }

        // Initialize applications manager when DOM is loaded
        let applicationsManager;
        document.addEventListener('DOMContentLoaded', function() {
            applicationsManager = new ApplicationsManager();
        });
    </script>
</body>
</html>


